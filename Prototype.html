<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Prototype Mapbox GL</title>
    <style>
	html, body{overflow:hidden;}

    .loader{
	    background-color : white;cursor: wait;height: 100%;left: 0;position: fixed;top: 0;width: 100%;z-index: 999999;
	}
    #loader-img{
	    position:absolute;left: 50%;top: 50%;width: 30px;height: 30px;margin-left: -15px; margin-top: -15px; 
    }
	.loader h1{
	    position : absolute;background: none;border: none;color: #45739B;font-size: 15px;top:60%;left : 50%;font-family: "Open Sans",sans-serif;font-variant: small-caps;font-weight: 700;height: 30px;width: 200px;margin-top : -15px;margin-left : -100px;text-align: center;
	}
	</style>    
	<!-- API MAPBOX GL-->
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.0/mapbox-gl.css' rel='stylesheet' />
    <!-- CHARGEMENT DES FEUILLES DE STYLE CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">  <!-- TEMPLATE -->
    <link href="css/startmin.css" rel="stylesheet"> <!-- FEUILLE DE STYLE PERSO -->
    <link href="css/font-awesome.min.css" rel="stylesheet" type="text/css">  <!-- AJOUT DES FLECHES MENU -->
    <link rel="stylesheet" href="EasyAutocomplete-1.3.5/easy-autocomplete.min.css"> <!-- BARRE DE RECHERCHE -->
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<!-- MAPBOX GL -->
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.0/mapbox-gl.js'></script>
<!-- JQUERY  -->
<script src="https://code.jquery.com/jquery-1.11.2.js" integrity="sha256-WMJwNbei5YnfOX5dfgVCS5C4waqvc+/0fV7W2uy3DyU=" crossorigin="anonymous"></script>
<!-- library for search box -->
<script src= "EasyAutocomplete-1.3.5/jquery.easy-autocomplete.min.js"></script>    
<!-- Bootstrap Core JavaScript -->
<script src="js/bootstrap.min.js"></script>
<!-- Metis Menu Plugin JavaScript -->
<script src="js/metisMenu.min.js"></script>
<!-- Custom Theme JavaScript -->
<script src="js/startmin.js"></script>
<!-- LOADER -->
<div class = "loader"><center><img id = "loader-img" src = 'css/ajax-loader.gif'><h1>Chargement de la page</h1></center></div>
<div id="wrapper">
    <!-- Navigation -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation" >
    <!-- Gestion du menu de couches -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <!-- Sidebar -->
        <div class="navbar-default sidebar" role="navigation">
            <div class="sidebar-nav navbar-collapse">
            <!-- Search bar -->  
            <ul class="nav" id="side-menu">
                <li class="sidebar-search">
                    <div id = "searchFieldContainer" class="input-group custom-search-form">
                        <input id= "searchfield" type="text" placeholder="Rechercher..." onkeypress="return runScriptKey(event)">
                            <span class="input-group-btn">
                                <button class="btn btn-primary" id = "searchButton" type="button" onclick = "return runScriptClic(event)">
                                    <i class="fa fa-search" ></i>
                                </button>
                            </span>                 
                    </div>
                </li>
                <!-- Gestion des couches -->                    
                <li>
                    <a href="#">Amphis et salles spécifiques <img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/amphitheatre.png"/><span class="fa arrow"></span></a>
                        <ul class="nav nav-second-level">
                            <li id = "Amphithéâtres">
                                <img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "case"><a href="#">Amphithéâtres</a>
                            </li>
                            <li id = "Salles informatique">
                                <img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "case"><a href="#">Salles informatique</a>
                            </li>
                            <li >                               
                                <a  id = "Salles spécifiques" href="#"><img  src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "caseB">Salles spécifiques<span class="fa arrow"></span></a>
                                <ul class="nav nav-third-level" id = "insertSallesSpecifiques"></ul>
                            </li>
                        </ul>
                    </li>

                    <li>
                        <a href="#">Structures et services <img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/scolarites.png"/><span class="fa arrow"></span></a>
                        <ul class="nav nav-second-level">
    						<li >
                                <a  id = "Services centraux" href="#"><img  src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "caseB">Services centraux<span class="fa arrow"></span></a>
                                <ul class="nav nav-third-level" id = "insertServicescen"></ul>
                            </li>
                            <li > 
                                <a  id = "Services généraux" href="#"><img  src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "caseB">Services généraux<span class="fa arrow"></span></a>
                                <ul class="nav nav-third-level" id = "insertServicesgen"></ul>
                            </li>
                            <li >
                                <a  id = "Services commun" href="#"><img  src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "caseB">Services commun<span class="fa arrow"></span></a>
                                <ul class="nav nav-third-level" id = "insertServicescom"></ul>
                            </li>
            
                        </ul>
                    </li>                                         
                    <li>
                        <a href="#">Bibliothèques et Culture<img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/biblio.png"/><span class="fa arrow"></span></a>
                        <ul class="nav nav-second-level">
                            <li id = "Bibliothèques">
                                 <img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "case"><a href="#">Bibliothèques</a>
                            </li>
                            <li>
                                <a  id = "Lieu culturel" href="#"><img  src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "caseB">Lieu culturel<span class="fa arrow"></span></a>
                                <ul class="nav nav-third-level" id = "insertLieuCulturel"></ul>                             
                            </li>                         
                        </ul>
                    </li>
                    <li>
                        <a href="#">Restauration et logement<img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/restos.png"/><span class="fa arrow"></span></a>
                        <ul class="nav nav-second-level">
                            <li id = "Restaurants universitaires">
                                <img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "case"><a href="#" >Restaurants universitaires</a>
                            </li>
                            <li id = "Caféterias">
                                 <img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "case"><a href="#" >Caféterias</a>
                            </li>
                            <li id = "Résidences universitaires">
                                 <img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "case"><a href="#" >Résidences universitaires</a>
                            </li>                            
                        </ul>
                    </li>
                    <li>
                        <a href="#">Sport et santé<img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/sport.png"/><span class="fa arrow"></span></a>
                        <ul class="nav nav-second-level">
                            <li id = "Equipements sportifs">
                                <img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "case"><a href="#" >Equipements sportifs</a>
                            </li>
                            <li id = "Pole santé">
                                <img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "case"><a href="#" >Pole santé</a>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <a href="#">Vie associative<img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/asso.png"/><span class="fa arrow"></span></a>
                        <ul class="nav nav-second-level">
                            <li  id = "Associations de filières">
                                <img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "case"><a href="#">Associations de filières</a>
                            </li>
                            <li id = "Associations de Masters et Doctorats">
                                <img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "case"><a href="#" >Associations de Masters et Doctorats</a>
                            </li>
                            <li id = "Associations culturelles, artistiques et sportives">
                                <img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "case"><a href="#" >Associations culturelles, artistiques et sportives</a>
                            </li>
                            <li id = "Associations de solidarité et de sensibilisation">
                                <img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "case"><a href="#" >Associations de solidarité et de sensibilisation</a>
                            </li>
                            <li id = "Associations briochines">
                                <img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "case"><a href="#" >Associations briochines  (Campus Mazier)</a>
                            </li>                          
                            <li id = "Autres">
                                <img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "case"><a href="#" >Autres</a>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <a href="#">Divers<img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/divers.png"/><span class="fa arrow"></span></a>
                        <ul class="nav nav-second-level" >
                            <li id = "Toilettes">
                                 <img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "case"><a href="#" >Toilettes</a>
                            </li>
                            <li id = "Copieurs">
                                 <img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "case"><a href="#" >Copieurs</a>
                            </li>
                            <li id = "Espace détente">
                                 <img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "case"><a href="#" >Espace détente</a>
                            </li>                            
                        </ul>
                    </li>
                    <li>
                        <a href="#">Mobilités et accessibilité<img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/mobilite.png"/><span class="fa arrow"></span></a>
                        <ul class="nav nav-second-level">
                            <li>
                                <a href="#">Se déplacer sur le campus <span class="fa arrow"></span></a>
                                <ul class="nav nav-third-level">
                                    <li id= "Ascenseurs">
                                         <img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "case"><a href="#" >Ascenseurs</a>
                                    </li>
                                    <li id = "Cheminements accessibles">
                                         <img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "case"><a href="#" >Cheminements accessibles</a>
                                    </li>                                                                                                             
                                </ul>
                            </li>
                            <li>
                                <a href="#">Accéder au campus <span class="fa arrow"></span></a>
                                <ul class="nav nav-third-level">
                                    <li id = "Réseau de bus">
                                         <img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "case"><a href="#" >Réseau de bus</a>
                                    </li>
                                    <li id = "Métro">
                                         <img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "case"><a href="#" >Métro</a>
                                    </li>
                                    <li id = "Parkings vélo">
                                         <img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "case"><a href="#" >Parkings vélo</a>
                                    </li>                                   
                                    <li id = "Stations vélostar">
                                         <img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "case"><a href="#" >Stations vélostar</a>
                                    </li>
                                    <li id = "Parkings">
                                         <img src = "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png" class = "case"><a href="#" >Parkings voiture</a>
                                    </li>                                                                                                                                                 
                                </ul>
                            </li>   
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
     <div id="page-wrapper" style = "padding:0">
        <div class="container-fluid" style = "padding-left:0;padding-right:0;padding-top : 0;padding-bottom : 0;margin-right: 0;margin-top : 0;margin-left: :0;margin-bottom : 0">
            <div class="row">
                <div class="col-lg-12"></div>
            </div>
            <div id="map" style="position:relative;margin-top:50px;margin-right:0;margin-left:0;margin-bottom:0;padding-right : 0;padding-left : 0; padding-top:0;padding-bottom:0;z-index:1;height:90vh">
                <div id="DDD" class="btn-group">
                </div>
                <div id="campus" class="btn-group">
                    <button  class="btn btn-primary" id="Villejean">Villejean</button>
                    <button  class="btn btn-primary" id="LaHarpe">La Harpe</button>
                    <button  class="btn btn-primary" id="Mazier">Saint Brieuc</button>
                </div>   
            </div>
        </div>
    </div>
</div>
<script>    
    ///////////////////////////////////////  Initialisation du fond de carte //////////////////////////////////
// Adapter le zoom, et la largeur / placement des raccourcis spatiaux en fonction de l'écran
    var largeurEcran = screen.width
    zoomBase = 15.8;
    var BoutonsD = document.getElementById("DDD")
	var Bouton2D = document.createElement('button');
	Bouton2D.setAttribute("class","btn btn-primary");
	Bouton2D.setAttribute("id","DDButton");
	Bouton2D.innerHTML = '2D';
	var Bouton3D = document.createElement('button');
	Bouton3D.setAttribute("class","btn btn-primary");
	Bouton3D.setAttribute("id","DDDButton");
	Bouton3D.innerHTML = '3D';
    if (largeurEcran < 500){
    	zoomBase = 14.8;
    	BoutonsD.style.position = 'absolute';
    	BoutonsD.style.height = '50px';
    	BoutonsD.style.width = '100px';
    	BoutonsD.style.top = '95%';
    	BoutonsD.style.left = '50%';
    	BoutonsD.style.marginTop = '-25px';
    	BoutonsD.style.marginLeft = '-50px';
    	BoutonsD.appendChild(Bouton2D);
    	BoutonsD.appendChild(Bouton3D);
    } else {
    	BoutonsD.appendChild(Bouton2D);
    	BoutonsD.appendChild(Bouton3D);
    }
    if (largeurEcran > 1500){zoomBase = 16.1;}
    if (largeurEcran > 1000) {https://github.com/Xueimuohtreb/Plan-interactif/upload/master/icons/iconfond
        document.getElementById('campus').style.width = '40%';
        document.getElementById('Villejean').style.width= '33%';
        document.getElementById('LaHarpe').style.width= '33%';
        document.getElementById('Mazier').style.width= '33%';
        document.getElementById('campus').style.marginLeft= '-20%';
    }
    //Limites de vue en fonction du campus visité
    //Villejean / La Harpe
    var rennesBounds = [
    [-1.787293,48.067191 ], // Southwest coordinates
    [-1.525772,48.169255 ]  // Northeast coordinates
    ];    
    //Mazier
    var mazierBounds = [
    [-2.810090, 48.488519],
    [-2.668165,48.534886]
    ];
  // Appel du fond de carte 
    var map = new mapboxgl.Map({
        container: 'map', // container id
        style: 'https://free.tilehosting.com/styles/basic/style.json?key=nWBK7ixdxgsIG534xdet', // stylesheet location
        center:  [ -1.7015402487767233, 48.11941846173602], // starting position [lng, lat]
        zoom: zoomBase,
        minZoom:13, // zoom minimal
        pitch : 0, // inclinaison de base
        maxBounds: rennesBounds,
        attributionControl : false // starting zoom
    });
    map.dragRotate.disable(); // vue 2D de base 

    ///////////////////////////////////////  initialisation des variables overlay ////////////////////////////////// 
    var case1 = 'https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case1.png'
    var case2 = 'https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/case2.png'    
 
    // Taille overlay:
    var tailleMarker = [1,13,0.1,25,1.5]; // taille adaptative des éléments type marker
    var taillePetitMarker = [1,13,0.05,25,1]
	var tailleLine = [1.5,13,2,22,18]; // taille des éléments type ligne
	var taillePoint = [1.5,13,2,22,60]; // taille adaptative des éléments type point
	var taillePicto = [1.5,13,0.25,22,1.7]; // taille adaptative des éléments type pictogramme 
    var Etiquette = []; // Liste des couches ayant des étiquettes (exemple amphithéâtres)
	var activeLayerBackground = '#EEEEEE' // couleur du background des lignes

	/////////////// VARIABLES COUCHES ////////////////////
    // Couche amphithéâtres
    var amphiCount = 0; // initialisation du compteur 
    var amphitheatresLink = document.getElementById('Amphithéâtres'); // Recherche de la balise html liée à la couche
    Etiquette.push('Amphithéâtre'); // Ajout des etiquettes
    var amphiInfoPopup = ['Nom','Batiment','Niveau','Capacite']; // Données ajoutées dans la popup
    var amphiURL = 'https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/layers_icons/amphi_marker.png';   
    // Couche salles informatique
    var sallesInfoCount = 0; 
    var sallesInfoLink = document.getElementById('Salles informatique');
    var sallesInfoInfoPopup = ['Nom','Batiment','Niveau','Info','Image','Mail','Tel','Lien'];
    var sallesInfoURL =  'https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/layers_icons/salle_info_marker.png';
    // Couche salles spécifiques
    var sallesSpeCount = 0;
    var listeSallesSpecifiques = []; // Création dynamique de la liste des salles à partir du jeu de données
    var sallesSpecifiquesLink = document.getElementById('Salles spécifiques');
    var insertSallesSpecifiques = document.getElementById('insertSallesSpecifiques');
    var sallesSpeInfoPopup = ['Nom','Batiment','Niveau','Info','Image','Mail','Tel','Lien'];
    var sallesSpeURL = 'https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/layers_icons/sallespe_marker.png' ;  
    // Services centraux
    var ServicescenCount = 0;
    var listeServicescen= []; // Création dynamique de la liste des salles à partir du jeu de données
    var ServicescenLink = document.getElementById('Services centraux');
    var insertServicescen = document.getElementById('insertServicescen');
    var ServicescenInfoPopup = ['Nom','Batiment','Niveau','Info','Image','Mail','Tel','Lien'];
    var ServicescenURL = 'https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/layers_icons/UFR_marker.png';   
    // Services commun
    var ServicescomCount = 0;
    var listeServicescom = []; // Création dynamique de la liste des salles à partir du jeu de données
    var ServicescomLink = document.getElementById('Services commun');
    var insertServicescom = document.getElementById('insertServicescom');
    var ServicescomInfoPopup = ['Nom','Batiment','Niveau','Info','Image','Mail','Tel','Lien'];
    var ServicescomURL = 'https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/layers_icons/UFR_marker.png';    
    // Services généraux
    var ServicesgenCount = 0;
    var listeServicesgen = []; // Création dynamique de la liste des salles à partir du jeu de données
    var ServicesgenLink = document.getElementById('Services généraux');
    var insertServicesgen = document.getElementById('insertServicesgen');
    var ServicesgenInfoPopup = ['Nom','Batiment','Niveau','Info','Image','Mail','Tel','Lien'];
    var ServicesgenURL = 'https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/layers_icons/UFR_marker.png';
    // Couche bibliothèques
    var bibliothequesCount = 0; // initialisation du compteur de clics
    var bibliothequesLink = document.getElementById("Bibliothèques");
    var bibliothequesInfoPopup = ['Nom','Categorie','Batiment','Niveau','Info','Mail','Tel','Lien'];
    var bibliothequesURL = 'https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/layers_icons/biblio_marker.png';
    // Couche Lieu culturel
    var lieuCulturelCount = 0; // initialisation du compteur de clics
    var lieuCulturelLink = document.getElementById('Lieu culturel');
    var listelieuCulturel = []; // Création dynamique de la liste des salles à partir du jeu de données
    var lieuCulturelInfoPopup = ['Nom','Categorie','Batiment','Niveau','Info','Capacite','Mail','Tel','Lien'];
    var insertLieuCulturel = document.getElementById('insertLieuCulturel');
    var lieuCulturelURL = 'https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/layers_icons/culture_marker.png';
    // Couche équipements sportifs
    var equipementSportifCount = 0; // initialisation du compteur de clics
    var equipementSportifLink = document.getElementById('Equipements sportifs');
    var equipementSportifInfoPopup = ['Nom','Categorie','Batiment','Niveau','Info'];
    var equipementSportifURL = 'https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/layers_icons/sport_marker.png';    
    // Couche toilettes
    var toilettesCount = 0; // initialisation du compteur de clics
    var toilettesLink = document.getElementById('Toilettes');
    var toilettesInfoPopup = ['Categorie','Batiment','Niveau','Info'];
    var toilettesURL = 'https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/layers_icons/wc_marker.png';  
    // Couche copieurs
    var copieurCount = 0; // initialisation du compteur de clics
    var copieurLink = document.getElementById('Copieurs');
    var copieursInfoPopup = ['Categorie','Batiment','Niveau','Info'];
    var copieursURL = 'https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/layers_icons/copieur_marker.png';
    // Couche espace détente
    var espaceDetenteCount = 0; // initialisation du compteur de clics
    var espaceDetenteLink = document.getElementById('Espace détente');
    var espaceDetenteInfoPopup = ['Categorie','Batiment','Niveau','Info'];
    var espaceDetenteURL = 'https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/layers_icons/espacedetente_marker.png';
    // Couche cafeterias
    var cafeteriasCount = 0; // initialisation du compteur de clics
    var cafeteriasLink = document.getElementById('Caféterias');
    var cafeteriasInfoPopup = ['Categorie','Batiment','Niveau','Info'];
    var cafeteriasURL = 'https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/layers_icons/cafeteria_marker.png';
    // Couche Résidences universitaires
    var resUnivCount = 0; // initialisation du compteur de clics
    var resUnivLink = document.getElementById("Résidences universitaires");
    var resUnivInfoPopup = ['Nom','Categorie','Batiment','Niveau','Info','Mail','Tel','Lien'];
    var resUnivURL = 'https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/layers_icons/resuniv_marker.png';
    // Couche Restaurants universitaires
    var restoUnivCount = 0; // initialisation du compteur de clics
    var restoUnivLink = document.getElementById("Restaurants universitaires");
    var restoUnivInfoPopup = ['Nom','Categorie','Batiment','Niveau','Info','Mail','Tel','Lien'];
    var restoUnivURL = 'https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/layers_icons/restauu_marker.png';
    // Couche Associations de filières
    var associationsfilieresCount = 0; // initialisation du compteur de clics
    var associationsfilieresLink = document.getElementById('Associations de filières');
    var associationsfilieresInfoPopup = ['Nom','Categorie','Batiment','Niveau','Info','Mail','Tel','Lien'];
    var associationsfilieresURL = 'https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/layers_icons/association_marker.png';
     // Couche Associations de Masters et Doctorats
    var associationsmasterCount = 0; // initialisation du compteur de clics
    var associationsmasterLink = document.getElementById('Associations de Masters et Doctorats');
    var associationsmasterInfoPopup = ['Nom','Categorie','Batiment','Niveau','Info','Mail','Tel','Lien'];
    var associationsmasterURL = 'https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/layers_icons/association_marker2.png';
    // Couche Associations briochines
    var associationsbriochinesCount = 0; // initialisation du compteur de clics
    var associationsbriochinesLink = document.getElementById('Associations briochines');
    var associationsbriochinesInfoPopup = ['Nom','Categorie','Batiment','Niveau','Info','Mail','Tel','Lien'];
    var associationsbriochinesURL = 'https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/layers_icons/association_marker3.png';
    // Couche Associations culturelles, artistiques et sportives
    var associationscasCount = 0; // initialisation du compteur de clics
    var associationscasLink = document.getElementById('Associations culturelles, artistiques et sportives');
    var associationscasInfoPopup = ['Nom','Categorie','Batiment','Niveau','Info','Mail','Tel','Lien'];
    var associationscasURL = 'https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/layers_icons/association_marker4.png';
    // Couche Associations de solidarité et de sensibilisation
    var associationssolidariteCount = 0; // initialisation du compteur de clics
    var associationssolidariteLink = document.getElementById('Associations de solidarité et de sensibilisation');
    var associationssolidariteInfoPopup = ['Nom','Categorie','Batiment','Niveau','Info','Mail','Tel','Lien'];
    var associationssolidariteURL = 'https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/layers_icons/association_marker5.png';
     // Couche Associations autres
    var associationsCount = 0; // initialisation du compteur de clics
    var associationsLink = document.getElementById('Autres');
    var associationsInfoPopup = ['Nom','Categorie','Batiment','Niveau','Info','Mail','Tel','Lien'];
    var associationsURL = 'https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/layers_icons/association_marker6.png';
    // Couche ascenseur
    var ascenseurCount = 0; // initialisation du compteur de clics
    var ascenseurLink = document.getElementById('Ascenseurs');
    var ascenseurColor = '#1da34a';
    var ascenseurInfoPopup = ['Categorie'];
    var ascenseurIconSize = [1.5,13,2,22,60];
    // Couche parking
    var parkingCount = 0; // initialisation du compteur de clics
    var parkingLink = document.getElementById('Parkings');
    var parkingInfoPopup = ['Categorie','Capacite'];
    var parkingURL = 'https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/layers_icons/paking_picto.png';
    // Couche parking PMR
    var parkingPMRCount = 0; // initialisation du compteur de clics
    var parkingPMRInfoPopup = ['Categorie'];
    var parkingPMRURL = 'https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/layers_icons/parkingH_picto.png';
    // Couche parking vélo
    var parkingVeloCount = 0; // initialisation du compteur de clics
    var parkingVeloLink = document.getElementById("Parkings vélo");
    var parkingVeloColor = 'purple';
    var parkingVeloInfoPopup = ['Categorie'];
    var parkingVeloIconSize = [1.5,13,2,22,60];
    // Couche Pole santé
    var polesanteCount = 0; // initialisation du compteur de clics
    var polesanteLink = document.getElementById('Pole santé');
    var polesanteInfoPopup = ['Nom','Categorie','Batiment','Niveau'];
    var polesanteURL = 'https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/layers_icons/sante_marker.png';
       // Lineaire PMR
    var lineairePMRCount = 0; // initialisation du compteur de clics
    var lineairePMRLink = document.getElementById("Cheminements accessibles");
    var lineairePMRColor = '#138fad';
    var lineairePMRInfoPopup = null;
    var lineairePMRType = 'line'    
    // Couche Accès PMR
    var accesPMRCount = 0; // initialisation du compteur de clics
    var accesPMRColor = '#138fad';
    var accesPMRInfoPopup = ['Categorie'];
    var accesPMRIconSize = [1.5,13,2,22,60]
       // Lineaire Metro
    var lineaireMetroCount = 0; // initialisation du compteur de clics
    var metroLink = document.getElementById("Métro");
    var lineaireMetroColor = 'red';
    var lineaireMetroInfoPopup = null;
    var lineaireMetroIconSize = [1.5,13,2,22,60];
    var lineaireMetroType = 'line';   
    // Couche Accès PMR
    var metroCount = 0; // initialisation du compteur de clics
    var metroColor = 'red';
    var metroInfoPopup = ['Categorie','Nom'];
    var metroIconSize = [1.5,13,4,22,80];
    var metroURL = 'https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/layers_icons/metro_picto.png';
    // Couche vélostar
    var velostarCount = 0; // initialisation du compteur de clics
    var velostarLink = document.getElementById("Parkings vélo");
    var velostarColor = 'green';
    var velostarInfoPopup = ['Categorie','Capacite'];
    // Couche bus
    var busLineCount = 0; // initialisation du compteur de clics
    var busLineLink = document.getElementById("Réseau de bus");
    var busLineColor = '#3893F5';
    var busLineInfoPopup = ['Categorie','Capacite'];



    ////////////// Autres variables
    var Layers = []; // Liste des couches
    var popup = null; // Variable popup
    var popupList = null; // Variable popup sur les listes d'enregistrements
    // Coordonnées de la salle sélectionnée
    var salleRX = null; 
    var salleRY = null;  
    //////////////////////////////////   Initialisation de de fonctions //////////////////////////////////////
    
    //Variables nécessaires à la fonctionnalité de changement de vue (2D -> 3D)
    var DDD = false; // Vue de base en 2D
    var bati2DId = 'bati2DId'; // Identifiant de la couche de bati 2D
    var bati2DCount = 0; // Nombre de fois que la couche de bati 2D a été appelée (< nécessité de changer d'identifiant)
    var bati3DId = 'bati3dId';  // Identifiant de la couche de bati 3D
    var bati3DCount = 0; // Nombre de fois que la couche de bati 3D a été appelée
    var bati2DHId = 'bati2DHId'; // idem couche hover
    var bati3DHId = 'bati3dHId'; // idem couche hover
    var etiqBati2DId = 'etiqBati2DId'; // idem couche etiquette
    var etiqBati3DId = 'etiqBati3DId'; // idem couche etiquette
    var popupBati = new mapboxgl.Popup({ // Popup Hover Bati
        closeButton: false,
        closeOnClick: false
        });
 var popupContent = null
    // Fonction pour afficher le référentiel bati 3D
    function getBati3D(){
        if (bati3DCount != 0){
            map.removeLayer(bati2DId); 
            map.removeLayer(bati2DHId);
            map.removeLayer(etiqBati2DId);      
        };
        bati3DCount += 1;
        bati3DId = 'bati3DId'+bati3DCount;
        bati3DHId = 'bati3DHId'+bati3DCount;
        etiqBati3DId = 'etiqBati3DId' + bati3DCount;
        map.addLayer({
            id: bati3DId,
            type: "fill-extrusion",
            source: {
                type: "geojson",
                data:  "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/bati/Bati_3D.geojson"
            },
            paint: {
                'fill-extrusion-color': '#d1d1e0', 
                'fill-extrusion-height':{
                    'type': 'identity',
                    'property': 'hauteur'
                },
                'fill-extrusion-base': {
                    'type': 'identity',
                    'property': 'hauteur_mi'},
                'fill-extrusion-opacity': 0.8
            }
        },Layers[0]);
        map.addLayer({
            id: bati3DHId,
            type: "fill-extrusion",
            source: {
                type: "geojson",
                data:  "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/bati/Bati_3D.geojson"
            },
            filter: ["==", "Nom", ""],
            paint: {
                'fill-extrusion-color': '#D82B09', 
                'fill-extrusion-height':{
                    'type': 'identity',
                    'property': 'hauteur'
                },
                'fill-extrusion-base': {
                    'type': 'identity',
                    'property': 'hauteur_mi'},
                'fill-extrusion-opacity': 0.8
            }
        },Layers[0]);
        map.on("mousemove", bati3DId, function(e) {
            map.setFilter(bati3DHId, ["==", "Id", e.features[0].properties.Id]);
            var popupTitle = '';
            popupContent = '';
            if (Layers.length == 0){
                if (e.features[0].properties.Nom !== "null"){
                    popupTitle = e.features[0].properties.Nom;
                }
                if (e.features[0].properties.Photos !== "null"){
                    popupContent += '<img src = \''+ e.features[0].properties.Photos+'\'/>'
                }
                if (e.features[0].properties.Infos !== "null"){
                    popupContent += '<p>'+e.features[0].properties.Infos+'<p>';
                }
                if (popupBati!==null){
                    popupBati.remove();
                    };
                if (e.features[0].properties.Nom !== "null"){
                    if ((popup == null || popup.isOpen()==false)  && (searchPopup == null || searchPopup.isOpen() ===false) && (popupList == null || popupList.isOpen() ===false)){
                        
                        popupBati = new mapboxgl.Popup({ 
                        offset: [0, -15],
                        closeButton: false
                    })
                        .setLngLat(e.lngLat)
                        .setHTML('<h1>'+popupTitle+'</h1>'+popupContent)
                            .addTo(map);
                    }                 
                }               
            }
        });                           
        // Reset the state-fills-hover layer's filter when the mouse leaves the layer.
        map.on("mouseleave", bati3DId, function() {
            map.setFilter(bati3DHId, ["==", "Id", ""]);
            popupBati.remove();
        }); 
        map.addLayer({
            id: etiqBati3DId,
            type: "symbol",
            source: {
                type: "geojson",
                data: "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data//habillage/batiments_centroides.geojson"
            },
            layout: {
                "text-field": "{name}",
                "text-anchor": "center",
                "text-size":{'base': 1.3,'stops': [[13, 2.2], [22, 60]]},
            },
            minzoom : 14,
        });
    };
var popupContent = null
    // Fonction pour afficher le référentiel bati 2D
    function getBati2D(){
        if (bati3DCount != 0){
            map.removeLayer(bati3DId);
            map.removeLayer(bati3DHId);
            map.removeLayer(etiqBati3DId);      
        };
        bati2DCount += 1;
        bati2DId = 'bati2DId'+bati2DCount;
        bati2DHId = 'bati2DHId'+bati2DCount;
        etiqBati2DId='etiqBati2DId' + bati2DCount;
        map.addLayer({
            id: bati2DId,
            type: "fill",
            source: {
                type: "geojson",
                data: "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/bati/Bati_2D.geojson"
            },
            paint: {
                'fill-color': '#9494b8',
                'fill-opacity':0.8
            }
        },Layers[0]);
        map.addLayer({
            id: bati2DHId,
            type: "fill",
            source: {
                type: "geojson",
                data: "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/bati/Bati_2D.geojson"
            },
            filter: ["==", "Id", ""],
            paint: {
                'fill-color': '#D82B09',
                'fill-opacity':0.5
            }
        },Layers[0]);
        map.on("mousemove", bati2DId, function(e) {
            map.setFilter(bati2DHId, ["==", "Id", e.features[0].properties.Id]);
            var popupTitle = '';
            popupContent = '';
            if (Layers.length == 0){
                if (e.features[0].properties.Nom !== "null"){
                    popupTitle = e.features[0].properties.Nom;
                }
                if (e.features[0].properties.Photo !== "null"){
                    popupContent += '<img src = \''+ e.features[0].properties.Photo+'\'/>'
                }
                if (e.features[0].properties.Info !== "null"){
                    popupContent += '<p>'+e.features[0].properties.Info+'<p>';
                }
                if (popupBati!==null){
                    popupBati.remove();
                    };
                if (e.features[0].properties.Nom !== "null"){
                    if ((popup == null || popup.isOpen()==false)  && (searchPopup == null || searchPopup.isOpen() ===false) && (popupList == null || popupList.isOpen() ===false)){
                        
                        popupBati = new mapboxgl.Popup({ 
                        offset: [0, -15],
                        closeButton: false
                    })
                        .setLngLat(e.lngLat)
                        .setHTML('<h1>'+popupTitle+'</h1>'+popupContent)
                            .addTo(map);
                    }
                }               
            }
        
        });
        // Reset the state-fills-hover layer's filter when the mouse leaves the layer.
        map.on("mouseleave", bati2DId, function() {
            map.setFilter(bati2DHId, ["==", "Id", ""]);
            popupBati.remove();
            }); 
        map.addLayer({
            id: etiqBati2DId,
            type: "symbol",
            source: {
                type: "geojson",
                data: "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/habillage/batiments_centroides.geojson"
            },
            layout: {
                "text-field": "{name}",
                "text-anchor": "center",
                "text-size":{'base': 1.3,'stops': [[13, 2.5], [22, 60]]},
                "text-max-width":8
            },
            minzoom : 14,
            });
        };



   function addCategoryOverlay(htmllink,nomDeLaCouche,ordre,type,colorOrUrl,iconSize,infoPopup,overlayCount,minZoom,maxZoom){
        ////////// AJOUT DES DONNEES TYPE LINEAIRE ////////////

        if (type=='line'){
	        if (overlayCount === 0){
	            map.addLayer({
	                id: nomDeLaCouche,
	                type: "line",
	                source: {
	                    type: "geojson",
	                    data: lines
	                },

			        layout: {
			            "line-join": "round",
			            "line-cap": "round"
			        },
			        filter : [ '==','Categorie',nomDeLaCouche],
			        paint: {
			            "line-color": colorOrUrl,
			            "line-width": {'base': iconSize[0],'stops': [[iconSize[1],iconSize[2]], [iconSize[3], iconSize[4]]]}
			        }
	            });   
	        Layers.push(nomDeLaCouche); 
            for (var i = 0; i < htmllink.childNodes.length; i++) {
                if (htmllink.childNodes[i].className == "case") {
                    notes = htmllink.childNodes[i];
                    notes.setAttribute('src',case2)
                    break;
                }        
            }
            htmllink.style.backgroundColor = activeLayerBackground;
        } else {
            var visibility = map.getLayoutProperty(nomDeLaCouche,'visibility');
            if (visibility === 'visible') {

                for (var i = 0; i < htmllink.childNodes.length; i++) {
                    if (htmllink.childNodes[i].className == "case") {
                        notes = htmllink.childNodes[i];
                        notes.setAttribute('src',case1)
                        break;
                    }        
                }
                htmllink.style.removeProperty('background-color');

                map.setLayoutProperty(nomDeLaCouche,'visibility','none');
                Layers = Layers.filter(item => item != nomDeLaCouche);
                if (etiquette){
                    map.setLayoutProperty(nomDeLaCoucheEtiquette,'visibility','none');
                    Layers = Layers.filter(item => item != nomDeLaCoucheEtiquette);   
                }
            } else {
                map.setLayoutProperty(nomDeLaCouche,'visibility','visible');
                Layers.push(nomDeLaCouche);

                for (var i = 0; i < htmllink.childNodes.length; i++) {
                    if (htmllink.childNodes[i].className == "case") {
                        notes = htmllink.childNodes[i];
                        notes.setAttribute('src',case2)
                        break;
                    }        
                }
                htmllink.style.backgroundColor = activeLayerBackground;
            }
        };
		////////// AJOUT DES DONNEES PONCTUELLES ////////////
        } else {
	        var etiquette = false;
	        var contenuPopup = infoPopup;
	        for(var i = 0; i < Etiquette.length; i++){
	            if (Etiquette[i]==nomDeLaCouche){
	                etiquette = true;
	                var nomDeLaCoucheEtiquette = nomDeLaCouche+'etiquette' 
	            }
	        }
	        if (overlayCount === 0){
	        	////////// AJOUT DES DONNEES PONCTUELLES (MARKER) ////////////
	        	if (type == 'marker'){
	        		var markerOffset = [-15,-20];
	        		if (iconSize.toString() === '1,13,0.1,25,1.5'){
	        			markerOffset = [-30,-50];
	        			console.log(markerOffset)
	        		} else if (iconSize.toString() === '1,13,0.05,25,1'){
	        			markerOffset = [-40,-50]
	        			console.log(markerOffset)
	        		
	        		}

					map.loadImage(colorOrUrl, function(error, image) {
				        if (error) throw error;
				        map.addImage(nomDeLaCouche+'image', image);
				        map.addLayer({
				            "id": nomDeLaCouche,
				            "type": "symbol",
				            "source": {
				                "type": "geojson",
				                "data": POIBrut
                				},
                			"filter" : [ '==','Categorie',nomDeLaCouche],
				            "layout": {
				                "icon-image": nomDeLaCouche+'image',
				                "icon-size":{'base': iconSize[0],'stops': [[iconSize[1],iconSize[2]], [iconSize[3], iconSize[4]]]},
				                "icon-allow-overlap": true,
				                "icon-offset":{ stops: [
           							[13, [0, markerOffset[0]]],
						            [22, [0, markerOffset[1]]]
						        ]}
				            },

				        });
				    });
				    Layers.push(nomDeLaCouche);

				    if (etiquette){                
		                function etiqOverlay(){
			                overlayEtiquette = map.addLayer({
			                    id: nomDeLaCoucheEtiquette,
			                    type: "symbol",
			                    source: {
			                        type: "geojson",
			                        data: POIBrut
			                    },
			                    filter : [ '==','Categorie',nomDeLaCouche],
			                    layout: {
			                        "text-field": "{Etiquette}",
			                        "text-anchor": "center",
			                        "text-size":{'base': 1.5,'stops': [[16.5, 13], [22, 40]]}, 
						            "text-allow-overlap": true,
						            "text-offset":{ stops: [
		           							[16.5, [0, -1.85]],
								            [20, [0, -1.85]]
								        ]}

			                    },
			                    paint: {
			                        "text-color":"white",
			                        },
			                    minzoom:16.5
			                    });
			                	map.moveLayer(nomDeLaCouche+'etiquette',0)
		                }
		                setTimeout(etiqOverlay,1000);
		                Layers.push(nomDeLaCoucheEtiquette);

		            }
	        	////////// AJOUT DES DONNEES PONCTUELLES (POINTS) ////////////
        		} 
        		if (type == 'point'){

	            map.addLayer({
	                id: nomDeLaCouche,
	                type: "circle",
	                source: {
	                    type: "geojson",
	                    data: POIBrut
	                },
	                filter : [ '==','Categorie',nomDeLaCouche],
	                layout: {'visibility': 'visible'}, 
	                paint: {
	                    "circle-radius": {'base': iconSize[0],'stops': [[iconSize[1],iconSize[2]], [iconSize[3], iconSize[4]]]},
	                    "circle-color" : colorOrUrl,
	                    "circle-opacity":0.9
	                    }
	                });   
	            if (etiquette){
	                overlayEtiquette = map.addLayer({
	                    id: nomDeLaCoucheEtiquette,
	                    type: "symbol",
	                    source: {
	                        type: "geojson",
	                        data: POIBrut
	                    },
	                    filter : [ '==','Categorie',nomDeLaCouche],
	                    layout: {
	                        "text-field": "{Etiquette}",
	                        "text-anchor": "center",
	                        "text-size":{'base': 1.5,'stops': [[13, 2], [22, 60]]}, 
	                    },
	                    paint: {
	                        "text-color":"white"
	                        },
	                    minzoom:15.5
	                    });
	                
	                Layers.push(nomDeLaCoucheEtiquette); 
	            	} 
	            }
	            if (type == 'picto') {
	            	console.log(colorOrUrl);
					map.loadImage(colorOrUrl, function(error, image) {
				        if (error) throw error;
				        map.addImage(nomDeLaCouche+'image', image);
				        map.addLayer({
				            "id": nomDeLaCouche,
				            "type": "symbol",
				            "source": {
				                "type": "geojson",
				                "data": POIBrut
                				},
                			"filter" : [ '==','Categorie',nomDeLaCouche],
				            "layout": {
				                "icon-image": nomDeLaCouche+'image',
				                "icon-size":{'base': iconSize[0],'stops': [[iconSize[1],iconSize[2]], [iconSize[3], iconSize[4]]]},
				                "icon-allow-overlap": true,
				            },

				        });
				    });
				    Layers.push(nomDeLaCouche);

				    if (etiquette){                
		                function etiqOverlay(){
			                overlayEtiquette = map.addLayer({
			                    id: nomDeLaCoucheEtiquette,
			                    type: "symbol",
			                    source: {
			                        type: "geojson",
			                        data: POIBrut
			                    },
			                    filter : [ '==','Categorie',nomDeLaCouche],
			                    layout: {
			                        "text-field": "{Etiquette}",
			                        "text-anchor": "center",
			                        "text-size":{'base': 1.5,'stops': [[13, 8], [22, 50]]}, 
						            "text-allow-overlap": true,
			                    },
			                    paint: {
			                        "text-color":"white",
			                        },
			                    minzoom:15.5
			                    });
			                	map.moveLayer(nomDeLaCouche+'etiquette',0)
		                }
		                setTimeout(etiqOverlay,1000);
		                Layers.push(nomDeLaCoucheEtiquette);

		            }

	            }      
	                Layers.push(nomDeLaCouche); 
	                if (htmllink.nodeName == 'LI'){
	                    for (var i = 0; i < htmllink.childNodes.length; i++) {
	                        if (htmllink.childNodes[i].className == "case") {
	                            notes = htmllink.childNodes[i];
	                            notes.setAttribute('src',case2)
	                            break;
	                        }        
	                    }
	                    htmllink.style.backgroundColor = activeLayerBackground;
	                }

	                if (htmllink.nodeName == 'A'){
	                    htmllink.childNodes[0].setAttribute('src',case2);
	                    htmllink.parentElement.style.backgroundColor = activeLayerBackground;
	                }


  		
	        } else {

	        	function hideLayer(nomDeLaCouche,htmllink){
	        		if (htmllink.nodeName == 'LI'){
	                    for (var i = 0; i < htmllink.childNodes.length; i++) {
	                        if (htmllink.childNodes[i].className == "case") {
	                            notes = htmllink.childNodes[i];
	                            notes.setAttribute('src',case1)
	                            break;
	                        }        
	                    }
	                    htmllink.style.removeProperty('background-color');

		                }
		                if (htmllink.nodeName == 'A' ){
		                    htmllink.childNodes[0].setAttribute('src',case1);
		                    htmllink.parentElement.style.removeProperty('background-color');

		                }
		                map.setLayoutProperty(nomDeLaCouche,'visibility','none');
		                Layers = Layers.filter(item => item != nomDeLaCouche);
		                if (popup) {popup.remove();}
		                if (etiquette){
		                    map.setLayoutProperty(nomDeLaCoucheEtiquette,'visibility','none');
		                    Layers = Layers.filter(item => item != nomDeLaCoucheEtiquette);
		                    if (popup) {popup.remove();}    
		                }
	        	}

	        	function showLayer(nomDeLaCouche,htmllink){
	                map.setLayoutProperty(nomDeLaCouche,'visibility','visible');

	                map.moveLayer(nomDeLaCouche,0)
	                Layers.push(nomDeLaCouche);
	                if (htmllink.nodeName == 'LI'){
	                    for (var i = 0; i < htmllink.childNodes.length; i++) {
	                        if (htmllink.childNodes[i].className == "case") {
	                            notes = htmllink.childNodes[i];
	                            notes.setAttribute('src',case2)
	                            break;
	                        }        
	                    }
	                    htmllink.style.backgroundColor = activeLayerBackground;

	                }
	                if (htmllink.nodeName == 'A'){
	                    htmllink.childNodes[0].setAttribute('src',case2);
	                    htmllink.parentElement.style.backgroundColor = activeLayerBackground;
	                }

	                if (etiquette){
	                    map.setLayoutProperty(nomDeLaCoucheEtiquette,'visibility','visible')
	                    Layers.push(nomDeLaCoucheEtiquette);
	                    map.moveLayer(nomDeLaCoucheEtiquette,0) 
	                }	        		
	        	}

	            var visibility = map.getLayoutProperty(nomDeLaCouche,'visibility');         

	            if (visibility === 'visible') {
	            	if (conflicts.includes(htmllink)){
	            		if (ordre !== "nav nav-third-level collapse"){
	            			hideLayer(nomDeLaCouche,htmllink);
	            		}
	            	} else {
	            		hideLayer(nomDeLaCouche,htmllink);	
	            	}            	
	            } else {
	            	showLayer(nomDeLaCouche,htmllink);
	            }
	        };
	            getPopup(contenuPopup,nomDeLaCouche,colorOrUrl,type);
	            map.on('mousemove', function (e) {
	                var features = map.queryRenderedFeatures(e.point, { layers: Layers });
	                map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
	            });
	        }
		}
    
function getPopup(infoPopup,couche,iconURL,type){
	console.log(type);
    map.on('click', function (e) {
        var features = map.queryRenderedFeatures(e.point, { 
            layers: [couche] 
        });
        var popupTitle = null;
        var popupContent = [];
        if (!features.length) {
            return;
        }
        var feature = features[0];        
        //Titre de la popup
        for(var i = 0; i < infoPopup.length; i++){ 
            if (infoPopup[i]=='Categorie'){
                popupTitle = feature.properties.Categorie;
            } 
        }
        for(var i = 0; i < infoPopup.length; i++){ 
            if (infoPopup[i]=='Nom'){
                if (feature.properties.Nom!== "null"){
                    popupTitle = feature.properties.Nom;
                }   
            } 
        }
        // Contenu de la popup
        for(var i = 0; i < infoPopup.length; i++){ 
            if (infoPopup[i]=='Batiment'){
                if (feature.properties.Batiment!== "null"){
                    popupContent += '<p>Batiment '+feature.properties.Batiment;
                }
            } 
        }       
        for(var i = 0; i < infoPopup.length; i++){ 
            if (infoPopup[i]=='Niveau'){
                if (feature.properties.Niveau !== "null"){
                    popupContent += ' '+feature.properties.Niveau;
                }
            } 
        }
        for(var i = 0; i < infoPopup.length; i++){ 
            if (infoPopup[i]=='Capacite'){
                if (feature.properties.Capacite !== "null"){
                    popupContent += '<p>'+feature.properties.Capacite+'<p>';
                }
            } 
        }           
        for(var i = 0; i < infoPopup.length; i++){ 
            if (infoPopup[i]=='Info'){
                if (feature.properties.Info !== "null"){
                    popupContent += '<p>'+feature.properties.Info+'<p>';
                }
            } 
        }   
        for(var i = 0; i < infoPopup.length; i++){
            if (infoPopup[i]=='Lien'){
                if (feature.properties.Lien !== "null"){
                    popupContent += '<p><a href = '+feature.properties.Lien+' target=\"_blank\">Site internet<a></p>';
                }
            } 
        }
        for(var i = 0; i < infoPopup.length; i++){
            if (infoPopup[i]=='Mail'){
                if (feature.properties.Mail !== "null"  ){
                    popupContent += '<p>Contacter par mail : '+feature.properties.Mail+'</p>';
                }
            } 
        }
        for(var i = 0; i < infoPopup.length; i++){
            if (infoPopup[i]=='Tel'){
                if (feature.properties.Tel !== "null"){
                    popupContent += '<p>Contacter par téléphone : '+feature.properties.Tel+'</p>';
                }
            } 
        } 
	  	for(var i = 0; i < infoPopup.length; i++){
		   	if (infoPopup[i]=='Image'){
		   		if (feature.properties.Image !== "null"){
		   			if (feature.properties.Categorie == 'Département de formation'){
                    popupTitle += '<img style = \'height : 60px; position : absolute; right : 0;top:0\' src = \''+ feature.properties.Image+'\'/>'
		   			} else {
                    popupContent += '<img style = \'height : 60px; left : 50%\' src = \''+ feature.properties.Image+'\'/>'
                	}
                }
            }
        } 		  
        if (type=='marker'){
        	popup = new mapboxgl.Popup({ 
            offset: [0,-40],
            closeButton: false
        	})
        	.setLngLat(feature.geometry.coordinates)
            .setHTML('<h1>'+popupTitle+'</h1>'+popupContent)
                .addTo(map);
        } else {
        	popup = new mapboxgl.Popup({ 
            offset: [0, -15],
            closeButton: false
        	})
        	.setLngLat(feature.geometry.coordinates)
            .setHTML('<h1>'+popupTitle+'</h1>'+popupContent)
                .addTo(map);
        }	

        }); 
}
var salleRecherchee = null
function createHTMLList(categorie,listeDeNoms,elementCible,overlayCount){

    salleRecherchee = null
    var listeLink = []; 
    elLink = null
    elList = null
    if (overlayCount == 0){
        var data = fproperties.filter(function(e){
            return e.Categorie === categorie;
        })
        for (i = 0; i < data.length; i++) {
            listeDeNoms.push(data[i]['Nom']);
        }              
        for (i = 0; i < listeDeNoms.length; i++){
            elList = document.createElement('li');
            elementCible.appendChild(elList);
            elLink = document.createElement('a');
            elLink.innerHTML = listeDeNoms[i];
            elLink.setAttribute('id',listeDeNoms[i]);
            elLink.setAttribute('href','#');
            var theFunction = 'javascript:switchPOI('+'\''+listeDeNoms[i].replace("'","!")+'\')'
            elLink.setAttribute('href',theFunction);
            elList.appendChild(elLink);
        }
        for (i = 0; i < listeDeNoms.length; i++){
            listeLink.push(document.getElementById(listeDeNoms[i]))
        }
    }
}
// Fonctions pour zoomer sur l'item sélectionné dans la liste
function getSwitchPopup(){
    var popupTitle = null;
    var popupContent = '';
    
    if (salleRecherchee.properties.Categorie !== null){
        popupTitle = salleRecherchee.properties.Categorie;
    }   
    if (salleRecherchee.properties.Nom !== null){
        popupTitle = salleRecherchee.properties.Nom;
    }
    if (salleRecherchee.properties.Batiment !== null){
        popupContent += '<p>Batiment '+salleRecherchee.properties.Batiment;
    }   
    if (salleRecherchee.properties.Niveau !== null){
        popupContent += ' '+salleRecherchee.properties.Niveau;
    }   
    if (salleRecherchee.properties.Capacite !== null){
        popupContent += '<p>'+salleRecherchee.properties.Capacite+'<p>';
    }
    if (salleRecherchee.properties.Info !== null){
        popupContent += '<p>'+salleRecherchee.properties.Info+'<p>';
    }
    if (salleRecherchee.properties.Lien !== null){
        popupContent += '<p><a href = '+salleRecherchee.properties.Lien+' target=\"_blank\">Site internet<a></p>';
    }
    if (salleRecherchee.properties.Mail !== null){
        popupContent += '<p>Contacter par mail : '+salleRecherchee.properties.Mail+'</p>';
    }
    if (salleRecherchee.properties.Tel !== null){
        popupContent += '<p>Contacter par téléphone :'+salleRecherchee.properties.Tel+'</p>';
    }
    popupList = new mapboxgl.Popup({
        offset:[0,-45],
        closeButton: false
    })
    .setLngLat(salleRecherchee.geometry.coordinates)
    .setHTML('<h1>'+popupTitle+'</h1><p>'+popupContent+'</p>')
        .addTo(map);
};
function switchPOI(value){
    value = value.replace("!","'");
    salleRecherchee = null;
    salleRX = null;
    salleRY = null;
    if (document.getElementById('fleche')){document.getElementById('fleche').remove();}
    var htmlPOI = document.getElementById(value);
    var htmlPOIParent = htmlPOI.parentNode;
    var fleche = document.createElement('img');
    fleche.setAttribute('src','https://upload.wikimedia.org/wikipedia/commons/0/0d/Pfeil.png');
    fleche.setAttribute('id','fleche');
    fleche.style.width = '20px';
    fleche.style.position = 'absolute';
    htmlPOIParent.insertBefore(fleche,htmlPOI);
    if (popup){
        popup.remove();
    }
    if (popupList){
        popupList.remove();
    }
    for(var i = 0; i < POI.length; i++){
        
        if (POI[i].properties.Nom === value){
            salleRecherchee = POI[i];
            }}
    salleRX = salleRecherchee.geometry.coordinates[0];
    salleRY = salleRecherchee.geometry.coordinates[1];
    if (salleRecherchee.properties.Campus === 'Mazier'){
        map.setMaxBounds(mazierBounds);
    } else {
        map.setMaxBounds(rennesBounds);
    };
    if (DDD){                   
        map.flyTo({
            center:[salleRX,salleRY],
            zoom:16.5,
            pitch:45,
            speed:0.6
        });
    } else {
        map.flyTo({
            center:[salleRX,salleRY],
            zoom:16.5,
            pitch:0,
            speed:0.6
        });             
    }
    getSwitchPopup();
    } 
//////////////////////////////////   Interactivité menus //////////////////////////////////////
    // ZOOMS sur les campus
    var zoomLaHarpe = document.getElementById("LaHarpe")
    zoomLaHarpe.addEventListener('click', function(){
        map.setMaxBounds(rennesBounds);
        map.flyTo({
            zoom:16,
            center:[-1.7091, 48.1254]
        });
        zoomLaHarpe.style.backgroundColor = '#286090';
        zoomVillejean.style.backgroundColor = 'grey';
        zoomMazier.style.backgroundColor = 'grey'
    });
    var zoomVillejean = document.getElementById("Villejean")
    zoomVillejean.style.backgroundColor = '#286090';
    zoomVillejean.addEventListener('click', function(){
        map.setMaxBounds(rennesBounds);
        map.flyTo({
            zoom:16,
            center:[-1.7013, 48.119365]
        });
        zoomVillejean.style.backgroundColor = '#286090';
        zoomMazier.style.backgroundColor = 'grey';
        zoomLaHarpe.style.backgroundColor = 'grey';
    });
    var zoomMazier = document.getElementById("Mazier")
    zoomMazier.addEventListener('click',function(){
        map.setMaxBounds(mazierBounds);
        map.flyTo({
            zoom:16,
            center:[-2.7410000,48.513033]
        });
        zoomMazier.style.backgroundColor = '#286090';
        zoomVillejean.style.backgroundColor = 'grey';
        zoomLaHarpe.style.backgroundColor = 'grey';
    });
//////////////////////////////////   Initialisation des données carte //////////////////////////////////////
var POIBrut = (function (){
var json = null;
$.ajax({
    'async':false,
    'global':false,
    'url' : "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/points.geojson",
    'dataType' : "json",
    'success' : function(data){
        json = data;
    }
        });
    return json;
})();
var POI = []; 
POI = POIBrut.features; 
    
var fproperties = POIBrut.features.map(function (el) {
    return el.properties; 
});     

var lines = (function (){
var jsonLines = null;
$.ajax({
    'async':false,
    'global':false,
    'url' : "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/lineaire.geojson",
    'dataType' : "json",
    'success' : function(data){
        jsonLines = data;
    }
        });
    return jsonLines;
})();


var ServicescenLinkState = null;
setInterval(function (){
	ServicescenLinkState = ServicescenLink.nextElementSibling.className;
},500);
var ServicesgenLinkState = null;
setInterval(function (){
	ServicesgenLinkState = ServicesgenLink.nextElementSibling.className;
},500);
var ServicescomLinkState = null;
setInterval(function (){
	ServicescomLinkState = ServicescomLink.nextElementSibling.className;
},500);

var conflicts = [ServicescomLink,ServicesgenLink,ServicescenLink];

map.on("load", function() {
    // Couche herbe
    map.addLayer({
        id: "Herbe",
        type: "fill",
        source: {
            type: "geojson",
            data: "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/habillage/grass.geojson"
        },
        paint: {
            'fill-color': '#A4E463',
            'fill-opacity':0.5
            }
        });
    
    // Couche référentiel bati 2D
    getBati2D();    
    
    // Couche piste athletisme
    map.addLayer({
        id: "Piste d'athlétisme Villejean",
        type: "fill",
        source: {
            type: "geojson",
            data: "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/habillage/piste_athle.geojson"
        },
        paint: {
            'fill-color': '#C09C83',
            'fill-opacity':0.85
        }
    });
    map.addLayer({
        id: "Terrain de football Villejean",
        type: "line",
        source: {
            type: "geojson",
            data: "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/habillage/terrain_football.geojson"
        },
        "paint": {
            'line-color': '#FFFFFF',
            'line-width' : {'base': 1.2,'stops': [[13, 0.5], [22, 3]]}
            }
        });

     //picto fond de carte
    //Bibliothèque
    map.loadImage("https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/iconfond/biblio.png", function(error, image) {
        if (error) throw error;
        map.addImage('biblio', image);
        map.addLayer({
            "id": "biblio",
            "type": "symbol",
            "source": {
                "type": "geojson",
                "data": "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/fondcarte/biblio.geojson"
            },
            "layout": {
                "visibility": 'visible',
				"icon-image": "biblio",
                "icon-size": 0.90
            },
			minzoom : 15,
        });
    });
	
    //Caféteria
    map.loadImage("https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/iconfond/cafe.png", function(error, image) {
        if (error) throw error;
        map.addImage('cafe', image);
        map.addLayer({
            "id": "cafeteria",
            "type": "symbol",
            "source": {
                "type": "geojson",
                "data": "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/fondcarte/cafeteria.geojson"
            },
            "layout": {
                "visibility": 'visible',
				"icon-image": "cafe",
                "icon-size": 0.80
            },
			minzoom : 16,
        });
    });
	
    //Restaurant U
    map.loadImage("https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/iconfond/resto.png", function(error, image) {
        if (error) throw error;
        map.addImage('resto', image);
        map.addLayer({
            "id": "ru",
            "type": "symbol",
            "source": {
                "type": "geojson",
                "data": "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/fondcarte/ru.geojson"
            },
            "layout": {
                "visibility": 'visible',
				"icon-image": "resto",
                "icon-size": 0.80
            },
			minzoom : 15,
        });
    });
	
    //Parking
    map.loadImage("https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/iconfond/parking.png", function(error, image) {
        if (error) throw error;
        map.addImage('parking', image);
        map.addLayer({
            "id": "parking",
            "type": "symbol",
            "source": {
                "type": "geojson",
                "data": "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/fondcarte/parking.geojson"
            },
            "layout": {
                "visibility": 'visible',
				"icon-image": "parking",
                "icon-size": 0.50
            },
			minzoom : 15,
        });
    });
	
    //Metro
    map.loadImage("https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/iconfond/metro.png", function(error, image) {
        if (error) throw error;
        map.addImage('metro', image);
        map.addLayer({
            "id": "metro",
            "type": "symbol",
            "source": {
                "type": "geojson",
                "data": "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/fondcarte/metro.geojson"
            },
            "layout": {
                "visibility": 'visible',
				"icon-image": "metro",
                "icon-size": 0.80
            },
			minzoom : 15,
        });
    });
	
    //Pôle Sante
    map.loadImage("https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/iconfond/sante.png", function(error, image) {
        if (error) throw error;
        map.addImage('sante', image);
        map.addLayer({
            "id": "polesante",
            "type": "symbol",
            "source": {
                "type": "geojson",
                "data": "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/fondcarte/polesante.geojson"
            },
            "layout": {
                "visibility": 'visible',
				"icon-image": "sante",
                "icon-size": 0.80
            },
			minzoom : 17,
        });
    });
	
    //Piscine
    map.loadImage("https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/iconfond/piscine.png", function(error, image) {
        if (error) throw error;
        map.addImage('piscine', image);
        map.addLayer({
            "id": "piscine",
            "type": "symbol",
            "source": {
                "type": "geojson",
                "data": "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/fondcarte/piscine.geojson"
            },
            "layout": {
                "visibility": 'visible',
				"icon-image": "piscine",
                "icon-size": 1.00
            },
			minzoom : 15,
        });
    });
	
    //Bus
    map.loadImage("https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/iconfond/bus.png", function(error, image) {
        if (error) throw error;
        map.addImage('bus', image);
        map.addLayer({
            "id": "bus",
            "type": "symbol",
            "source": {
                "type": "geojson",
                "data": "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/fondcarte/bus.geojson"
            },
            "layout": {
                "visibility": 'visible',
				"icon-image": "bus",
                "icon-size": 0.60
            },
			minzoom : 16,
        });
    });
       

    

    
//////////////////////////////////   OVERLAYS //////////////////////////////////////

//////////////////////////////////  Groupe Amphis et salles spécifiques //////////////////////////////////////


    amphitheatresLink.onclick = function(e){
        addCategoryOverlay(amphitheatresLink,'Amphithéâtre','layer','marker',amphiURL,tailleMarker,amphiInfoPopup,amphiCount);
        amphiCount += 1;
    }
    sallesInfoLink.onclick = function(e){
        addCategoryOverlay(sallesInfoLink,'Salle informatique','layer','marker',sallesInfoURL,tailleMarker,sallesInfoInfoPopup,sallesInfoCount);
        sallesInfoCount += 1;
    }
    sallesSpecifiquesLink.onclick = function(e){
        addCategoryOverlay(sallesSpecifiquesLink,'Salles spécifiques','list','marker',sallesSpeURL,tailleMarker,sallesSpeInfoPopup,sallesSpeCount);
        if (sallesSpeCount==0){
            createHTMLList('Salles spécifiques',listeSallesSpecifiques,insertSallesSpecifiques,sallesSpeCount);
        }
        sallesSpeCount +=1;
    }

//////////////////////////////////  Structures et services //////////////////////////////////////

    ServicescomLink.onclick = function(e){
        addCategoryOverlay(ServicescomLink,'Services commun',ServicescomLinkState,'marker',ServicescomURL,tailleMarker,ServicescomInfoPopup,ServicescomCount);
        if (ServicescomCount==0){
            createHTMLList('Services commun',listeServicescom,insertServicescom,ServicescomCount);
        }
        ServicescomCount += 1;
    }
    ServicesgenLink.onclick = function(e){
        addCategoryOverlay(ServicesgenLink,'Services généraux',ServicesgenLinkState,'marker',ServicesgenURL,tailleMarker,ServicesgenInfoPopup,ServicesgenCount);
        if (ServicesgenCount==0){
            createHTMLList('Services généraux',listeServicesgen,insertServicesgen,ServicesgenCount);
        }
        ServicesgenCount += 1;
    }    
    ServicescenLink.onclick = function(e){
        addCategoryOverlay(ServicescenLink,'Services centraux',ServicescenLinkState,'marker',ServicescenURL,tailleMarker,ServicescenInfoPopup,ServicescenCount);
        if (ServicescenCount==0){
            createHTMLList('Services centraux',listeServicescen,insertServicescen,ServicescenCount);
        }
        ServicescenCount += 1;
    }

//////////////////////////////////  Bibliothèques et culture //////////////////////////////////////
    lieuCulturelLink.onclick = function(e){
        addCategoryOverlay(lieuCulturelLink,'Lieu culturel','list','marker',lieuCulturelURL,tailleMarker,lieuCulturelInfoPopup,lieuCulturelCount);
        if (lieuCulturelCount==0){
            createHTMLList('Lieu culturel',listelieuCulturel,insertLieuCulturel,lieuCulturelCount);
        }
        lieuCulturelCount += 1;
    }
    bibliothequesLink.onclick = function(e){
        addCategoryOverlay(bibliothequesLink,'Bibliothèques','layer','marker',bibliothequesURL,tailleMarker,bibliothequesInfoPopup,bibliothequesCount);
        bibliothequesCount += 1;
    }

////////////////////////////////// Restauration et logement //////////////////////////////////////
    resUnivLink.onclick = function(e){
        addCategoryOverlay(resUnivLink,'Résidence Universitaire','layer','marker',resUnivURL,tailleMarker,resUnivInfoPopup,resUnivCount);
        resUnivCount += 1;
    }
    restoUnivLink.onclick = function(e){
        addCategoryOverlay(restoUnivLink,'Restaurant Universitaire','layer','marker',restoUnivURL,tailleMarker,restoUnivInfoPopup,restoUnivCount);
        restoUnivCount += 1;
    }
    cafeteriasLink.onclick = function(e){
        addCategoryOverlay(cafeteriasLink,'Cafétéria','layer','marker',cafeteriasURL,taillePetitMarker,cafeteriasInfoPopup,cafeteriasCount);
        cafeteriasCount += 1;
    }


//////////////////////////////////  Sport et santé //////////////////////////////////////
    equipementSportifLink.onclick = function(e){
        addCategoryOverlay(equipementSportifLink,'Equipement sportif','layer','marker',equipementSportifURL,tailleMarker,equipementSportifInfoPopup,equipementSportifCount);
        equipementSportifCount += 1;
    }

    polesanteLink.onclick = function(e){
        addCategoryOverlay(polesanteLink,'Pole santé','layer','marker',polesanteURL,tailleMarker,polesanteInfoPopup,polesanteCount);
        polesanteCount += 1;
    }


//////////////////////////////////  Vie associative ///////////////////////////////////////


    associationsfilieresLink.onclick = function(e){
        addCategoryOverlay(associationsfilieresLink,'Associations de filières','layer','marker',associationsfilieresURL,taillePetitMarker,associationsfilieresInfoPopup,associationsfilieresCount);
        associationsfilieresCount += 1;
    }
   associationsmasterLink.onclick = function(e){
    addCategoryOverlay(associationsmasterLink,'Associations de Masters et Doctorats','layer','marker',associationsmasterURL,taillePetitMarker,associationsmasterInfoPopup,associationsmasterCount);
    associationsmasterCount += 1;
    }
     associationsbriochinesLink.onclick = function(e){
        addCategoryOverlay(associationsbriochinesLink,'Associations briochines','layer','marker',associationsbriochinesURL,taillePetitMarker,associationsbriochinesInfoPopup,associationsbriochinesCount);
        associationsbriochinesCount += 1;
 		for (var i = 0; i < Layers.length; i++) {        
 			if (Layers[i] = 'Associations briochines'){
 			map.setMaxBounds(mazierBounds);
	        map.flyTo({
	            center:[-2.7410000,48.513033],
	            zoom:16.5,
	            pitch:0,
	            speed:0.6
	        });
	        zoomMazier.style.backgroundColor = '#286090';
	        zoomVillejean.style.backgroundColor = 'grey';
	        zoomLaHarpe.style.backgroundColor = 'grey';
    		}
    	}
    }
    associationscasLink.onclick = function(e){
        addCategoryOverlay(associationscasLink,'Associations culturelles, artistiques et sportives','layer','marker',associationscasURL,taillePetitMarker,associationscasInfoPopup,associationscasCount);
        associationscasCount += 1;
    }
      associationssolidariteLink.onclick = function(e){
        addCategoryOverlay(associationssolidariteLink,'Associations de solidarité et de sensibilisation','layer','marker',associationssolidariteURL,taillePetitMarker,associationssolidariteInfoPopup,associationssolidariteCount);
        associationssolidariteCount += 1;
    }
     associationsLink.onclick = function(e){
        addCategoryOverlay(associationsLink,'Autres','layer','marker',associationsURL,taillePetitMarker,associationsInfoPopup,associationsCount);
        associationsCount += 1;
    }

//////////////////////////////////  Divers ///////////////////////////////////////


    toilettesLink.onclick = function(e){
        addCategoryOverlay(toilettesLink,'Toilettes','layer','marker',toilettesURL,taillePetitMarker,toilettesInfoPopup,toilettesCount);
        toilettesCount += 1;
    }
    copieurLink.onclick = function(e){
        addCategoryOverlay(copieurLink,'Copieur','layer','marker',copieursURL,tailleMarker,copieursInfoPopup,copieurCount);
        copieurCount += 1;
    }
    
    espaceDetenteLink.onclick = function(e){
        addCategoryOverlay(espaceDetenteLink,'Espace détente','layer','marker',espaceDetenteURL,tailleMarker,espaceDetenteInfoPopup,espaceDetenteCount);
        espaceDetenteCount += 1;
    }

//////////////////////////////////  Mobilité et accessibilité ///////////////////////////////////////

    ascenseurLink.onclick = function(e){
        addCategoryOverlay(ascenseurLink,'Ascenseur','layer','point',ascenseurColor,ascenseurIconSize,ascenseurInfoPopup,ascenseurCount);
        ascenseurCount += 1;
    }
    parkingLink.onclick = function(e){
        addCategoryOverlay(parkingLink,'Parking','layer','picto',parkingURL,taillePicto,parkingInfoPopup,parkingCount);
        parkingCount += 1;
        addCategoryOverlay(parkingLink,'Parking PMR','layer','picto',parkingPMRURL,taillePicto,parkingPMRInfoPopup,parkingPMRCount);
        parkingPMRCount += 1;
    }

    
    parkingVeloLink.onclick = function(e){
        addCategoryOverlay(parkingVeloLink,'Parking vélo','layer','point',parkingVeloColor,parkingVeloIconSize,parkingVeloInfoPopup,parkingVeloCount);
        parkingVeloCount += 1;
    }
    lineairePMRLink.onclick = function(e){
        addCategoryOverlay(lineairePMRLink,'Cheminements accessibles','layer','line',lineairePMRColor,tailleLine,lineairePMRInfoPopup,lineairePMRCount);
        lineairePMRCount += 1;
        addCategoryOverlay(lineairePMRLink,'Accès PMR','layer','point',accesPMRColor,accesPMRIconSize,accesPMRInfoPopup,accesPMRCount);
        accesPMRCount += 1;        
    }

    metroLink.onclick = function(e){
        addCategoryOverlay(metroLink,'Cheminements Métro','layer','line',lineaireMetroColor,lineaireMetroIconSize,lineaireMetroInfoPopup,lineaireMetroCount);
        lineaireMetroCount += 1;
        addCategoryOverlay(metroLink,'Métro','layer','picto',metroURL,taillePicto,metroInfoPopup,metroCount);
        metroCount += 1;        
    }   
    velostarLink.onclick = function(e){
        addCategoryOverlay(velostarLink,'Station vélostar','layer','point',velostarColor,taillePoint,velostarInfoPopup,velostarCount);
        velostarCount += 1;       
    }
    busLink.onclick = function(e){
        addCategoryOverlay(busLink,'Cheminements Bus','layer','line',busLineColor,tailleLine,busLineInfoPopup,busLineCount);
        busLineCount += 1;       
    }           
});
//////////////////////////////////// couches temps réel //////////////////////////////////////////////
// Velostar 
var geojsonVelos = null;
var previousDataVelos = { times: [], stations: [] };
var prevInfo = null;
var velostarTRCount = 0
var nomLayer= null
var velostarLink = document.getElementById('Stations vélostar');
velostarLink.onclick = function (e) {
    velostarTRCount +=1 ;
    if (velostarTRCount === 1){
        updateData();
        function updateData() {
            //Appel de l'API pour les vélos
            $.ajax({
                //URL de l'API
                url: "https://data.explore.star.fr/api/records/1.0/search/?dataset=vls-stations-etat-tr&facet=nom&facet=etat&facet=nombreemplacementsactuels&facet=nombreemplacementsdisponibles&facet=nombrevelosdisponibles&format=geojson&rows=150",
                
                //Type de données
                dataType: "jsonp",
                crossDomain: true,
                
                //Méthode appelée lorsque le téléchargement a fonctionné
                success: function(geojson) {
                    console.log("Données téléchargées");
                    geojsonVelos = geojson;
                    saveBikeData();
                    if (nomLayer === null) {
                        showBikeData()
                    } else {
                        var visibility = map.getLayoutProperty(nomLayer,'visibility');
                        if (visibility === 'visible'){
                            showBikeData()
                        } else {
                            console.log('données masquées')
                        }
                    };
                    setTimeout(updateData, 60*1000);
                },
                
                //Méthode appelée lorsque le téléchargement a échoué
                error: function() {
                    alert("Erreur lors du téléchargement des vélos !");
                }      
            });
        };
        function saveBikeData() {
            //On change la structure des données pour simplifier l'utilisation
            var stations = {};
            var prevStationData = null;
            geojsonVelos.features.forEach(f => {
                stations[f.properties.nom] = f.properties;
                
                //On compare avec le nombre de vélos précédent
                if(previousDataVelos.stations.length > 0) {
                    f.properties.diff = f.properties.nombrevelosdisponibles - previousDataVelos.stations[previousDataVelos.stations.length-1][f.properties.nom].nombrevelosdisponibles;
                }
                else {
                    f.properties.diff = 0;
                }
                
                //On met à jour l'affichage des infos si besoin
                if(prevInfo && prevInfo === f.properties.nom) {
                    prevStationData = f;
                }
            });
            
            previousDataVelos.times.push(Date.now());
            previousDataVelos.stations.push(stations);
            Layers = Layers.filter(item => item != "bikes"+(previousDataVelos.times.length-1));
        }
        function showBikeData() {
            //On supprime les données précédentes
            if(previousDataVelos.times.length > 1) {
                map.removeLayer("bikes"+(previousDataVelos.times.length-1));
            }
            
            //On créé un nouveau calque de données
            nomLayer = "bikes"+previousDataVelos.times.length;
            Layers.push(nomLayer);
            map.addLayer({
                id: nomLayer,
                type: "circle",
                source: {
                    type: "geojson",
                    data: geojsonVelos
                },
                filter: ["has", "diff"],
                paint: {
                    "circle-radius": {'base': 1.5,'stops': [[13, 5], [22, 60]]},
                    "circle-color": "green"
                }
            });
        }       
    } else {
        var clickedLayer = this.textContent;
        e.preventDefault();
        e.stopPropagation();
        var visibility = map.getLayoutProperty(nomLayer,'visibility');
        if (visibility === 'visible') {
            map.setLayoutProperty(nomLayer,'visibility','none');
            Layers = Layers.filter(item => item != nomLayer);
        } else {
            map.setLayoutProperty(nomLayer,'visibility','visible');
            Layers.push(nomLayer);
            }
    };
        
    map.on('click', function (e) {
        var features = map.queryRenderedFeatures(e.point, { 
            layers: [nomLayer] 
        });
        if (!features.length) {
            return;
        }
        var feature = features[0];
        popup = new mapboxgl.Popup({ 
            offset: [0, -15],
            closeButton: false,
        })
            .setLngLat(feature.geometry.coordinates)
            .setHTML('<h1> Station vélostar : '+feature.properties.nom+'</h1><p>Nombre de vélos disponibles : '+feature.properties.nombrevelosdisponibles+'<br>Nombre d\'emplacements disponibles : ' +feature.properties.nombreemplacementsdisponibles+'</p>')
                .addTo(map);
        });
        map.on('mousemove', function (e) {
            var features = map.queryRenderedFeatures(e.point, { layers: Layers });
            map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
        });    
    }
// Couche des BUS
var geojsonBus = null;
var previousDataBus = { times: [], stations: [] };
var prevInfo = null;
var busTRCount = 0
var nomLayerBus= null
var busLink = document.getElementById('Réseau de bus');
busLink.onclick = function (e) {
    busTRCount +=1;
    if (busTRCount === 1){
        updateBusData();
        function updateBusData() {
            //Appel de l'API pour les vélos
            $.ajax({
                //URL de l'API
                url: "https://data.explore.star.fr/api/records/1.0/search/?dataset=tco-bus-vehicules-position-tr&facet=numerobus&facet=etat&facet=nomcourtligne&facet=sens&facet=destination&facet=ecartsecondes&format=geojson&rows=500",
                
                //Type de données
                dataType: "jsonp",
                crossDomain: true,
                
                //Méthode appelée lorsque le téléchargement a fonctionné
                success: function(geojson) {
                    console.log("Données téléchargées");
                    geojsonBus = geojson;
                    saveBusData();
                    if (nomLayerBus === null) {
                        showBusData()
                    } else {
                        var visibility = map.getLayoutProperty(nomLayerBus,'visibility');
                        if (visibility === 'visible'){
                            showBusData()
                        } else {
                            console.log('données masquées')
                        }
                    };
                    setTimeout(updateBusData, 60*1000);
                },
                
                //Méthode appelée lorsque le téléchargement a échoué
                error: function() {
                    alert("Erreur lors du téléchargement des bus !");
                }      
            });
        };
        function saveBusData() {
            //On change la structure des données pour simplifier l'utilisation
            var stations = {};
            var prevStationData = null;
            
            
            previousDataBus.times.push(Date.now());
            previousDataBus.stations.push(stations);
            Layers = Layers.filter(item => item != "bus"+(previousDataBus.times.length-1));
        }
        function showBusData() {
            //On supprime les données précédentes
            if(previousDataBus.times.length > 1) {
                map.removeLayer("bus"+(previousDataBus.times.length-1));
            }
            
            //On créé un nouveau calque de données
            nomLayerBus = "bus"+previousDataBus.times.length;
            Layers.push(nomLayerBus);
            map.addLayer({
                id: nomLayerBus,
                type: "circle",
                source: {
                    type: "geojson",
                    data: geojsonBus
                },
                filter : [ '==','etat','En ligne'],                
                paint: {
                    "circle-radius": {'base': 1.7,'stops': [[13, 5], [22, 60]]},
                    "circle-color": "#0066ff"
                }
            });
        }       
        busCount +=1;
    } else {
        var clickedLayer = this.textContent;
        e.preventDefault();
        e.stopPropagation();
        var visibility = map.getLayoutProperty(nomLayerBus,'visibility');
        if (visibility === 'visible') {
            map.setLayoutProperty(nomLayerBus,'visibility','none');
            Layers = Layers.filter(item => item != nomLayerBus);
        } else {
            map.setLayoutProperty(nomLayerBus,'visibility','visible');
            Layers.push(nomLayerBus);
            }
    };
        
    map.on('click', function (e) {
        var features = map.queryRenderedFeatures(e.point, { 
            layers: [nomLayerBus] 
        });
        if (!features.length) {
            return;
        }
        var feature = features[0];
        popup = new mapboxgl.Popup({ 
            offset: [0, -15],
            closeButton: false,
        })
            .setLngLat(feature.geometry.coordinates)
            .setHTML('<h1> Bus du réseau STAR </h1><p>Ligne : '+feature.properties.nomcourtligne+'<br>A destination de : '+feature.properties.destination+'</p>')
                .addTo(map);
        });
        map.on('mousemove', function (e) {
            var features = map.queryRenderedFeatures(e.point, { layers: Layers });
            map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
        });    
    }
    
//////////////////////////////////  Barre de recherche //////////////////////////////////////
    
    // initialisation des popup
    var searchPopup = null
    var jproperties = fproperties.filter(function(e){
        return e.Nom !== null;
    })
    // Récupération des propriétés du json
    var searchValue = null;
    var searchItem = [];
    var searchX = null;
    var searchY = null;
    var searchLayerCount = 0;
    var searchLayerId = 'SearchResult';
    var searchPopup = null
    var options = {
        data: jproperties,
        getValue: "Nom",
        template: {
            type: "description",
            fields: {
            // Possibilité de mettre le campus en description
                description: "Campus"
            }
        },
        list: {
            match: {
                enabled: true
            }
        },
        theme: "plate-dark"
    };
    $("#searchfield").easyAutocomplete(options);        
    
    function getSearchPopup(){
        var popupTitle = searchItem.properties.Nom;
        var popupContent = '';

        if (searchItem.properties.Batiment != null ){
            popupContent += '<p>Batiment '+searchItem.properties.Batiment;
        };
        if (searchItem.properties.Niveau != null){
            popupContent += ' '+searchItem.properties.Niveau;
        };
        if (searchItem.properties.Info != null ){
            popupContent += '<p>'+searchItem.properties.Info+'<p>';
        };
        if (searchItem.properties.Capacite != null){
            popupContent += '<p>'+searchItem.properties.Capacite+'<p>';
        };
        if (searchItem.properties.Lien != null ){
            popupContent += '<p><a href = '+searchItem.properties.Lien+' target=\"_blank\">Site internet<a></p>';
        };
        if (searchItem.properties.Mail != null ){
            popupContent += '<p>Contacter par mail : '+searchItem.properties.Mail+'</p>';
        };
        if (searchItem.properties.Tel != null ){
            popupContent += '<p>Contacter par téléphone : '+searchItem.properties.Tel+'</p>';
        };
        if (searchItem.properties.Image != null  ){
        	if (searchItem.properties.Categorie == 'Département de formation'){
        		popupTitle += '<img style = \'height : 60px ; position : absolute ; right : 0\' src = \''+ searchItem.properties.Image+'\'/>';
        	} else {
            popupContent += '<img style = \'height : 50px\' src = \''+ searchItem.properties.Image+'\'/>';
        	}
        };
        searchPopup = new mapboxgl.Popup({
            offset:[0,-45],
            closeButton: false
    })
        .setLngLat(searchItem.geometry.coordinates)
        .setHTML('<h1>'+popupTitle+'</h1><p>'+popupContent+'</p>')
            .addTo(map);
    };  
    var cross = null;
    var searchBarCrossPresence = null;
    function getSearchedItem(){
        if (searchValue !==null){
                searchValue = null
                searchItem = [];
                searchX = null;
                searchY = null;
                Layers = Layers.filter(item => item != searchLayerId);
                searchLayerCount+=1;
                searchPopup.remove();
                map.removeLayer(searchLayerId)
                searchLayerId = 'searchResult'+searchLayerCount;
            };
            searchValue = document.getElementById("searchfield").value;
            for(var i = 0; i < POI.length; i++){
                if (POI[i].properties.Nom === searchValue){
                    searchItem = POI[i];
                    


					map.loadImage('https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/layers_icons/recherche.png', function(error, image) {
				        if (error) throw error;
				        map.addImage(searchLayerId+'image', image);
				        map.addLayer({
				            "id": searchLayerId,
				            "type": "symbol",
				            "source": {
				                "type": "geojson",
				                "data": searchItem
                				},
				            "layout": {
				                "icon-image": searchLayerId+'image',
				                "icon-size":{'base': tailleMarker[0],'stops': [[tailleMarker[1],tailleMarker[2]], [tailleMarker[3], tailleMarker[4]]]},
				                "icon-allow-overlap": true,
				                "icon-offset":{ stops: [
           							[13, [0, -15]],
						            [22, [0, -60]]
						        ]}
				            },
				        });
				    });


                Layers.push(searchLayerId);
                map.on('mousemove', function (e) {
                    var features = map.queryRenderedFeatures(e.point, { layers: Layers });
                    map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
                });
                searchX = searchItem.geometry.coordinates[0];
                searchY = searchItem.geometry.coordinates[1];
                if (POI[i].properties.Campus === 'Mazier'){
                    map.setMaxBounds(mazierBounds);
                    zoomVillejean.style.backgroundColor = 'grey';
                    zoomMazier.style.backgroundColor = '#286090';
                    zoomLaHarpe.style.backgroundColor = 'grey';
                } 
                if (POI[i].properties.Campus === 'Villejean'){
                    map.setMaxBounds(rennesBounds);
                    zoomVillejean.style.backgroundColor = '#286090';
                    zoomMazier.style.backgroundColor = 'grey';
                    zoomLaHarpe.style.backgroundColor = 'grey';
                } 
                if (POI[i].properties.Campus === 'La Harpe'){
                    map.setMaxBounds(rennesBounds);
                    zoomVillejean.style.backgroundColor = 'grey';
                    zoomMazier.style.backgroundColor = 'grey';
                    zoomLaHarpe.style.backgroundColor = '#286090';
                } 
                if (DDD){                   
                    map.flyTo({
                        center:[searchX,searchY],
                        zoom:16.5,
                        pitch:45,
                        speed:0.6
                    });
                } else {
                    map.flyTo({
                        center:[searchX,searchY],
                        zoom:16.5,
                        pitch:0,
                        speed:0.6
                    });             
                }
                getSearchPopup();
                map.on('click',function (e){
                    if (searchPopup.isOpen() == true){
                        searchPopup.remove();
                    
                    }
                })
                var beforeCross = document.getElementById('searchfield');
                if (searchBarCrossPresence == null) {
                	searchBarCrossPresence = 'yes';
                	cross = document.createElement('img');
	                cross.setAttribute('src','https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/icons/cross_searchbar.png');
	                cross.style.height = '15px';
	                cross.style.top = '7px';
	                cross.style.marginLeft = '128px';
	                cross.style.position = 'absolute';
	                cross.style.right = '2px';
	                cross.style.cursor = 'pointer';
	                beforeCross.parentNode.insertBefore(cross,beforeCross.nextSibling);
	                cross.onclick = function(e){
	                	Layers = Layers.filter(item => item != searchLayerId);
	                	map.removeLayer(searchLayerId);
	                	searchPopup.remove();
	                	cross.parentNode.removeChild(cross);
	                	searchBarCrossPresence = null;
	                }
	            }
            }
        }
    }

function runScriptKey(e) {
    if (e.keyCode == 13) {
        getSearchedItem();
    }
}
function runScriptClic(e){
    getSearchedItem();
}
    
    
//////////////////////////////////   3D   //////////////////////////////////////
DDButton = document.getElementById('DDButton');
DDDButton =  document.getElementById('DDDButton');
DDButton.style.backgroundColor = "#286090"
DDD = false

DDDButton.addEventListener('click',function(){
    var X = map.getCenter()["lng"];
    var Y = map.getCenter()["lat"];
    var currentZoom = map.getZoom()
    if (DDD===false){
        Y = Y -0.00021;
        getBati3D();
        zoomCible = currentZoom +0.5;
        map.flyTo({
            center:[X,Y],
            pitch:60,
            speed:0.08,
            zoom:zoomCible
        });
        DDDButton.style.backgroundColor = '#286090';
        DDD=true;
        map.dragRotate.enable();
        DDButton.style.backgroundColor = "grey";
    }
})
DDButton.addEventListener('click',function(){
    var X = map.getCenter()["lng"];
    var Y = map.getCenter()["lat"];
    var currentZoom = map.getZoom()
    var button = document.getElementById('DDDButton');
    if (DDD){
        Y = Y +0.00021;
        getBati2D();
        zoomCible = currentZoom -0.5;
        map.flyTo({
            center:[X,Y],
            pitch:0,
            speed:0.08,
            zoom:zoomCible
        });
        map.dragRotate.disable();

        DDButton.style.backgroundColor = '#286090';
        DDD=false;

        map.dragRotate.enable();
        DDDButton.style.backgroundColor = "grey"
	}
})
//////////////////////////////////   Ajout de l'habillage de la carte //////////////////////////////////////
var nav = new mapboxgl.NavigationControl();
map.addControl(nav, 'top-left');
map.addControl(new mapboxgl.ScaleControl({
maxWidth: 120,
unit: 'metric'}));

map.addControl(new mapboxgl.GeolocateControl({
    positionOptions: {
        enableHighAccuracy: true
    },
    trackUserLocation: true
}));
if (screen.width>700){
	attributionContainer = document.createElement('div');
	attributionContainer.style.backgroundColor='white';
	attributionContainer.style.position = 'absolute';
	attributionContainer.style.background = 'rgba(255,255,255, 0.5)';
	attributionContainer.style.bottom = '0';
	attributionContainer.style.right = '0';
	attributionContainer.style.display = 'inline-block';
	attributionContainer.style.zIndex = '9999';

	attributionLink1 = document.createElement('a');
	attributionLink1.innerHTML = '© OpenMapTiles '
	attributionLink1.setAttribute("class","attribution");
	attributionLink1.setAttribute('href','https://openmaptiles.org');

	attributionLink2 = document.createElement('a');
	attributionLink2.innerHTML = '© OpenStreetMap contributors ';
	attributionLink2.setAttribute("class","attribution");
	attributionLink2.setAttribute('href','http://www.openstreetmap.org/about');

	attributionLink3 = document.createElement('a');
	attributionLink3.innerHTML = '© Mapbox GL ';
	attributionLink3.setAttribute("class","attribution");
	attributionLink3.setAttribute('href','https://www.mapbox.com/mapbox-gl-js/api');

	attributionLink4 = document.createElement('a');
	attributionLink4.innerHTML = '© Master SIGAT';
	attributionLink4.setAttribute("class","attribution");
	attributionLink4.setAttribute('href','https://esigat.wordpress.com');

	var carte = document.getElementById('map');
	carte.appendChild(attributionContainer);
	attributionContainer.appendChild(attributionLink1);
	attributionContainer.appendChild(attributionLink2);
	attributionContainer.appendChild(attributionLink3);
	attributionContainer.appendChild(attributionLink4);
}

</script>
<script>jQuery(window).load(function(){ jQuery(".loader").fadeOut("200"); });</script>

</body>
</html>
