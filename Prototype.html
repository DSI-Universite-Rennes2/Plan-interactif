<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Prototype Mapbox GL</title>

    <!-- API MAPBOX GL-->
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.0/mapbox-gl.css' rel='stylesheet' />

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom Fonts -->
    <link href="css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="css/startmin.css" rel="stylesheet">
	
	<!-- JQUERY  -->
	<script src="https://code.jquery.com/jquery-1.11.2.js"
  integrity="sha256-WMJwNbei5YnfOX5dfgVCS5C4waqvc+/0fV7W2uy3DyU="
  crossorigin="anonymous"></script>
	
	<!-- Stylesheet for search box -->
	<link rel="stylesheet" href="EasyAutocomplete-1.3.5/easy-autocomplete.min.css"> 

	<!-- library for search box -->
	<script src= "EasyAutocomplete-1.3.5/jquery.easy-autocomplete.min.js"></script> 
	
	<!-- Bootstrap Core JavaScript -->
	<script src="js/bootstrap.min.js"></script>
	<!-- Metis Menu Plugin JavaScript -->
	<script src="js/metisMenu.min.js"></script>
	<!-- Custom Theme JavaScript -->
	<script src="js/startmin.js"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>
<body>
<!-- jQuery -->


<div id="wrapper">

    <!-- Navigation -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation" >
	<!-- Gestion du menu de couches -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>

        <!-- Sidebar -->
        <div class="navbar-default sidebar" role="navigation">
            <div class="sidebar-nav navbar-collapse">

	<!-- Search bar -->
		    
			<ul class="nav" id="side-menu">

				<li class="sidebar-search">
					<div class="input-group custom-search-form">
						<input id= "searchfield" type="text" placeholder="Rechercher..." onkeypress="return runScriptKey(event)">
							<span class="input-group-btn">
								<button class="btn btn-primary" id = "searchButton" type="button" onclick = "return runScriptClic(event)">
									<i class="fa fa-search" ></i>
								</button>
							</span>					
					</div>
				</li>

        		<!-- Gestion des couches -->
                    
		    	<li>
                	<a href="#">Amphis et salles spécifiques<span class="fa arrow"></span></a>
                        <ul class="nav nav-second-level">
                            <li>
                                <a href="#" id = "Amphithéâtres">Amphithéâtres</a>
                            </li>
                            <li>
                                <a href="#" id = "Salles informatique">Salles informatique</a>
                            </li>
                            <li>
                                <a href="#" id = 'Salles spécifiques'>Salles spécifiques<span class="fa arrow"></span></a>
                                <ul class="nav nav-third-level" id = "insertSallesSpecifiques">
                                                                                                                                                
                                </ul>
                            </li>

                        </ul>
                    </li>
					<li>
                        <a href="#">Scolarité et Administration<span class="fa arrow"></span></a>
                        <ul class="nav nav-second-level">
                            <li>
                                <a href="#" id = "Scolarités">Scolarités</a>
                            </li>
                            <li>
                                <a href="#" id ="Secrétariats">Secrétariat</a>
                            </li>
                        </ul>
                    </li>
		    		<li>
                        <a href="#">Bibliothèques et Culture<span class="fa arrow"></span></a>
                        <ul class="nav nav-second-level">
                            <li>
                                <a href="#" id = "Bibliothèques">Bibliothèques</a>
                            </li>
                            <li>
                                <a href="#" id = 'Lieu culturel'>Lieu culturel<span class="fa arrow"></span></a>
                                <ul class="nav nav-third-level" id = "insertLieuCulturel">
                                                                                                                                            
                                </ul>                               
                            </li>
                            <!--
                            <li>
                                <a href="#">Galerie arts et essais</a>
                            </li>
                            -->                            
                        </ul>
                    </li>
				 	<li>
                        <a href="#">Restauration et logement<span class="fa arrow"></span></a>
                        <ul class="nav nav-second-level">
                            <li>
                                <a href="#" id = "Restaurants universitaires">Restaurants universitaires</a>
                            </li>
                            <li>
                                <a href="#" id = "Caféterias">Caféterias</a>
                            </li>
                            <li>
                                <a href="#" id = "Machines à café">Machines à café</a>
                            </li>
                            <li>
                                <a href="#" id = "Résidences universitaires">Résidences universitaires</a>
                            </li>                            
                        </ul>
                    </li>


		    		<li>
                        <a href="#">Sport et santé<span class="fa arrow"></span></a>
                        <ul class="nav nav-second-level">
                            <li>
                                <a href="#" id = "Equipements sportifs">Equipements sportifs</a>
                            </li>
                            <li>
                                <a href="#" id = "Pole santé">Pole santé</a>
                            </li>
                        </ul>
                    </li>


                    <li>
                        <a href="#">Vie associative<span class="fa arrow"></span></a>
                        <ul class="nav nav-second-level">
                            <li>
                                <a href="#" id = "Associations">Associations</a>
                            </li>
                            <li>
                                <a href="#" id = "Ressourcerie">Ressourcerie</a>
                            </li>
                            <li>
                                <a href="#" id = "Le potager">Le potager</a>
                            </li>

                        </ul>
                    </li>


                    <li>
                        <a href="#">Services divers<span class="fa arrow"></span></a>
                        <ul class="nav nav-second-level" >
                            <li>
                                <a href="#" id = "Toilettes">Toilettes</a>
                            </li>

                            <li>
                                <a href="#" id = "Copieurs">Copieurs</a>
                            </li>
                            <li>
                                <a href="#" id = "Espace détente">Espace détente</a>
                            </li>                            
                        </ul>
                    </li>


                    <li>
                        <a href="#">Mobilités et accessibilité<span class="fa arrow"></span></a>
                        <ul class="nav nav-second-level">
                            <li>
                                <a href="#">Se déplacer sur le campus <span class="fa arrow"></span></a>
                                <ul class="nav nav-third-level">
                                    <li>
                                    	<a href="#" id= "Ascenseurs">Ascenseurs</a>
                                    </li>
                                    <li>
                                        <a href="#" id = "Escaliers">Escaliers</a>
                                    </li>
                                    <li>
                                        <a href="#" id = "Accès PMR">Accès PMR</a>
                                    </li>
                                    <li>
                                        <a href="#" id = "Cheminements accessibles">Cheminements accessibles</a>
                                    </li>                                                                                                             
                                </ul>
                            </li>

                            <li>
                                <a href="#">Accéder au campus <span class="fa arrow"></span></a>
                                <ul class="nav nav-third-level">
                                    <li>
                                        <a href="#" id = "Réseau de bus">Réseau de bus</a>
                                    </li>
                                    <li>
                                        <a href="#" id = "Métro">Métro</a>
                                    </li>
                                    <li>
                                        <a href="#" id = "Parkings vélo">Parkings vélo</a>
                                    </li>                                   
                                    <li>
                                        <a href="#" id = "Stations vélostar">Stations vélostar</a>
                                    </li>
                                    <li>
                                        <a href="#" id = "Parkings">Parkings</a>
                                    </li>
                                    <li>
                                        <a href="#" id = "Places handicapés">Places handicapés</a>
                                    </li>                                                                                                                                                   
                                </ul>
                            </li>	
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

     <div id="page-wrapper" style = "padding:0">
        <div class="container-fluid" style = "padding-left:0;
					      padding-right:0;
					      padding-top : 0;
					      padding-bottom : 0;
					      margin-right: 0;
					      margin-top : 0;
					      margin-left: :0;
					      margin-bottom : 0">

            <div class="row">
                <div class="col-lg-12"></div>
            </div>

         	<div id="map" style="position:relative;
				 margin-top:50px;
				 margin-right:0;
				 margin-left:0;
				 margin-bottom:0;
				 padding-right : 0;
				 padding-left : 0; 
				 padding-top:0;
				 padding-bottom:0;
				 z-index:1;
			     height:90vh">
				<div id="DDD" class="btn-group">
					<button  class="btn btn-primary" id="DDDButton">3D</button>
 				</div>
 				<div id="campus" class="btn-group">
					<button  class="btn btn-primary" id="Villejean">Villejean</button>
					<button  class="btn btn-primary" id="LaHarpe">La Harpe</button>
					<button  class="btn btn-primary" id="Mazier">Mazier</button>
 				</div>	 
			</div>
    	</div>
    </div>
</div>



<script>
	
	
	///////////////////////////////////////  initialisation du fond de carte //////////////////////////////////

		//Limites de vue en fonction du campus visité
		//Villejean / La Harpe
		var rennesBounds = [
	    [-1.787293,48.067191 ], // Southwest coordinates
	    [-1.525772,48.169255 ]  // Northeast coordinates
		];
		
		//Mazier
		var mazierBounds = [
		[-2.810090, 48.488519],
		[-2.668165,48.534886]
		];
	

	    var map = new mapboxgl.Map({
	        container: 'map', // container id
	        style: 'https://free.tilehosting.com/styles/basic/style.json?key=nWBK7ixdxgsIG534xdet', // stylesheet location
	        center: [-1.7013, 48.119365], // starting position [lng, lat]
	        zoom: 15.8,
			minZoom:13, // zoom minimal
	        pitch : 0, // inclinaison de base
			maxBounds: rennesBounds // starting zoom
    	});
		map.dragRotate.disable(); // vue 2D de base 


	///////////////////////////////////////  initialisation des variables overlay //////////////////////////////////

	var Etiquette = []; // Insérer les couches ayant des étiquettes (exemple amphithéâtres)
	var Layers = [];

	// Initialisation des variables d'overlay
	var popup = null
	var popupList = null
	

	// Couche amphithéâtres
	var amphiCount = 0; // initialisation du compteur de clics
	var amphitheatresLink = document.getElementById('Amphithéâtres');
	var amphiColor = '#003399';
	Etiquette.push('Amphithéâtre');
	var amphiInfoPopup = ['Nom','Batiment','Niveau','Capacite'];
	var amphiIconSize = [1.5,13,2,22,60]

	// Couche salles informatique
	var sallesInfoCount = 0; // initialisation du compteur de clics
	var sallesInfoLink = document.getElementById('Salles informatique');
	var sallesInfoColor = '#ff4000'
	var sallesInfoInfoPopup = ['Nom','Batiment','Niveau','Capacite','Info'];
	var sallesInfoIconSize = [1.5,13,2,22,60]

	// Couche salles spécifiques
	var sallesSpeCount = 0;
	var salleRX = null; // Coordonnées de la salle sélectionnée
	var salleRY = null;
	var sallesSpeColor = 'blue';
	var listeSallesSpecifiques = []; // Création dynamique de la liste des salles à partir du jeu de données
	var sallesSpecifiquesLink = document.getElementById('Salles spécifiques');
	var insertSallesSpecifiques = document.getElementById('insertSallesSpecifiques');
	var sallesSpeInfoPopup = ['Nom','Batiment','Niveau'];
	var sallesSpeIconSize = [1.5,13,2,22,60]

	// Couche toilettes
	var toilettesCount = 0; // initialisation du compteur de clics
	var toilettesLink = document.getElementById('Toilettes');
	var toilettesColor = 'green';
	var toilettesInfoPopup = ['Categorie','Batiment','Niveau','Info'];
	var toilettesIconSize = [1.5,13,2,22,60]

	// Couche copieurs
	var copieurCount = 0; // initialisation du compteur de clics
	var copieurLink = document.getElementById('Copieurs');
	var copieurColor = 'purple';
	var copieursInfoPopup = ['Categorie','Batiment','Niveau','Info'];
	var copieursIconSize = [1.5,13,2,22,60]

	// Couche équipements sportifs
	var equipementSportifCount = 0; // initialisation du compteur de clics
	var equipementSportifLink = document.getElementById('Equipements sportifs');
	var equipementSportifColor = 'purple';
	var equipementSportifInfoPopup = ['Nom','Categorie','Batiment','Niveau','Info'];
	var equipementSportifIconSize = [1.5,13,2,22,60]

	// Couche Lieu culturel
	var lieuCulturelCount = 0; // initialisation du compteur de clics
	var lieuCulturelLink = document.getElementById('Lieu culturel');
	var listelieuCulturel = []; // Création dynamique de la liste des salles à partir du jeu de données
	var lieuCulturelColor = 'purple';
	var lieuCulturelInfoPopup = ['Nom','Categorie','Batiment','Niveau','Info','Capacite','Mail','Tel','Lien'];
	var insertLieuCulturel = document.getElementById('insertLieuCulturel');
	var lieuCulturelIconSize = [1.5,13,2,22,60]


	// Couche espace détente
	var espaceDetenteCount = 0; // initialisation du compteur de clics
	var espaceDetenteLink = document.getElementById('Espace détente');
	var espaceDetenteColor = 'purple';
	var espaceDetenteInfoPopup = ['Categorie','Batiment','Niveau','Info'];
	var espaceDetenteIconSize = [1.5,13,2,22,60]


	// Couche cafeterias
	var cafeteriasCount = 0; // initialisation du compteur de clics
	var cafeteriasLink = document.getElementById('Caféterias');
	var cafeteriasColor = 'purple';
	var cafeteriasInfoPopup = ['Categorie','Batiment','Niveau','Info'];
	var cafeteriasIconSize = [1.5,13,2,22,60]
	
	// Couche associations
	var associationsCount = 0; // initialisation du compteur de clics
	var associationsLink = document.getElementById('Associations');
	var associationsColor = 'purple';
	var associationsInfoPopup = ['Categorie','Batiment','Niveau','Info','Mail','Tel','Lien'];
	var associationsIconSize = [1.5,13,2,22,60]

	// Couche ascenseur
	var ascenseurCount = 0; // initialisation du compteur de clics
	var ascenseurLink = document.getElementById('Ascenseurs');
	var ascenseurColor = 'purple';
	var ascenseurInfoPopup = ['Categorie'];
	var ascenseurIconSize = [1.5,13,2,22,60]

	// Couche parking
	var parkingCount = 0; // initialisation du compteur de clics
	var parkingLink = document.getElementById('Parkings');
	var parkingColor = 'purple';
	var parkingInfoPopup = ['Categorie'];
	var parkingIconSize = [1.5,13,2,22,60]

	// Couche parking PMR
	var parkingPMRCount = 0; // initialisation du compteur de clics
	var parkingPMRLink = document.getElementById('Places handicapés');
	var parkingPMRColor = 'purple';
	var parkingPMRInfoPopup = ['Categorie'];
	var parkingPMRIconSize = [1.5,13,2,22,60]

	// Couche parking vélo
	var parkingVeloCount = 0; // initialisation du compteur de clics
	var parkingVeloLink = document.getElementById("Parkings vélo");
	var parkingVeloColor = 'purple';
	var parkingVeloInfoPopup = ['Categorie'];
	var parkingVeloIconSize = [1.5,13,2,22,60]


//////////////////////////////////   Initialisation de de fonctions //////////////////////////////////////
	
	//Variables nécessaires à la fonctionnalité de changement de vue (2D -> 3D)
	var DDD = false; // Vue de base en 2D
	var bati2DId = 'bati2DId'; // Identifiant de la couche de bati 2D
	var bati2DCount = 0; // Nombre de fois que la couche de bati 2D a été appelée (< nécessité de changer d'identifiant)
	var bati3DId = 'bati3dId';  // Identifiant de la couche de bati 3D
	var bati3DCount = 0; // Nombre de fois que la couche de bati 3D a été appelée
	var bati2DHId = 'bati2DHId'; // idem couche hover
	var bati3DHId = 'bati3dHId'; // idem couche hover
	var etiqBati2DId = 'etiqBati2DId'; // idem couche etiquette
	var etiqBati3DId = 'etiqBati3DId'; // idem couche etiquette

    var popupBati = new mapboxgl.Popup({ // Popup Hover Bati
        closeButton: false,
        closeOnClick: false
        });

 var popupContent = null
	// Fonction pour afficher le référentiel bati 3D
	function getBati3D(){
		if (bati3DCount != 0){
			map.removeLayer(bati2DId); 
			map.removeLayer(bati2DHId);
			map.removeLayer(etiqBati2DId);		
		};
		bati3DCount += 1;
		bati3DId = 'bati3DId'+bati3DCount;
		bati3DHId = 'bati3DHId'+bati3DCount;
		etiqBati3DId = 'etiqBati3DId' + bati3DCount;
		map.addLayer({
			id: bati3DId,
			type: "fill-extrusion",
			source: {
				type: "geojson",
				data:  "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/Bati_3D.geojson"
			},
			paint: {
				'fill-extrusion-color': '#d1d1e0', 
				'fill-extrusion-height':{
					'type': 'identity',
					'property': 'hauteur'
				},
				'fill-extrusion-base': {
					'type': 'identity',
					'property': 'hauteur_mi'},
				'fill-extrusion-opacity': 0.8
			}
		},Layers[0]);
		map.addLayer({
			id: bati3DHId,
			type: "fill-extrusion",
			source: {
				type: "geojson",
				data:  "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/Bati_3D.geojson"
			},
			filter: ["==", "Nom", ""],

			paint: {
				'fill-extrusion-color': '#D82B09', 
				'fill-extrusion-height':{
					'type': 'identity',
					'property': 'hauteur'
				},
				'fill-extrusion-base': {
					'type': 'identity',
					'property': 'hauteur_mi'},
				'fill-extrusion-opacity': 0.8
			}
		},Layers[0]);
		map.on("mousemove", bati3DId, function(e) {

			map.setFilter(bati3DHId, ["==", "Id", e.features[0].properties.Id]);
            var popupTitle = '';
            popupContent = '';


			if (e.features[0].properties.Nom !== "null"){
				popupTitle = e.features[0].properties.Nom;
			}

			if (e.features[0].properties.Photos !== "null"){
				popupContent += '<img src = \''+ e.features[0].properties.Photos+'\'/>'
			}
						console.log(e.features[0].properties.Infos);

			if (e.features[0].properties.Infos !== "null"){
				popupContent += '<p>'+e.features[0].properties.Infos+'<p>';
			}
            if (popupBati!==null){
                popupBati.remove();
                };
            if (e.features[0].properties.Nom !== "null"){
	            if ((popup == null || popup.isOpen()==false)  && (searchPopup == null || searchPopup.isOpen() ===false) && (popupList == null || popupList.isOpen() ===false)){

	            	
	                popupBati = new mapboxgl.Popup({ 
	                offset: [0, -15],
	                closeButton: false
	            })
	                .setLngLat(e.lngLat)
	                .setHTML('<h1>'+popupTitle+'</h1>'+popupContent)
	                    .addTo(map);
	            }

            }   
            });
       
                                  
		// Reset the state-fills-hover layer's filter when the mouse leaves the layer.
		map.on("mouseleave", bati3DId, function() {
			map.setFilter(bati3DHId, ["==", "Id", ""]);
            popupBati.remove();
		});	

		map.addLayer({
	        id: etiqBati3DId,
	        type: "symbol",
	        source: {
	            type: "geojson",
	            data: "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/batiments_centroides.geojson"
	        },
			layout: {
		        "text-field": "{name}",
		        "text-anchor": "center",
		        "text-size":{'base': 1.4,'stops': [[13, 2], [22, 60]]}
    		},
    		minzoom : 14,
	    });

	};
var popupContent = null
	// Fonction pour afficher le référentiel bati 2D
	function getBati2D(){
		if (bati3DCount != 0){
			map.removeLayer(bati3DId);
			map.removeLayer(bati3DHId);
			map.removeLayer(etiqBati3DId);		
		};
		bati2DCount += 1;
		bati2DId = 'bati2DId'+bati2DCount;
		bati2DHId = 'bati2DHId'+bati2DCount;
		etiqBati2DId='etiqBati2DId' + bati2DCount;
		map.addLayer({
			id: bati2DId,
			type: "fill",
			source: {
				type: "geojson",
				data: "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/Bati_2D.geojson"
			},
			paint: {
				'fill-color': '#9494b8',
				'fill-opacity':0.8
			}
		},Layers[0]);
		map.addLayer({
			id: bati2DHId,
			type: "fill",
			source: {
				type: "geojson",
				data: "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/Bati_2D.geojson"
			},
			filter: ["==", "Id", ""],
			paint: {
				'fill-color': '#D82B09',
				'fill-opacity':0.5
			}
		},Layers[0]);
		map.on("mousemove", bati2DId, function(e) {
			map.setFilter(bati2DHId, ["==", "Id", e.features[0].properties.Id]);
            var popupTitle = '';
            popupContent = '';


			if (e.features[0].properties.Nom !== "null"){
				popupTitle = e.features[0].properties.Nom;
			}

			if (e.features[0].properties.Photo !== "null"){
				popupContent += '<img src = \''+ e.features[0].properties.Photo+'\'/>'
			}

			if (e.features[0].properties.Info !== "null"){
				popupContent += '<p>'+e.features[0].properties.Info+'<p>';
			}
            if (popupBati!==null){
                popupBati.remove();
                };
            if (e.features[0].properties.Nom !== "null"){
	            if ((popup == null || popup.isOpen()==false)  && (searchPopup == null || searchPopup.isOpen() ===false) && (popupList == null || popupList.isOpen() ===false)){

	            	
	                popupBati = new mapboxgl.Popup({ 
	                offset: [0, -15],
	                closeButton: false
	            })
	                .setLngLat(e.lngLat)
	                .setHTML('<h1>'+popupTitle+'</h1>'+popupContent)
	                    .addTo(map);
	            }

            }         

        });
		// Reset the state-fills-hover layer's filter when the mouse leaves the layer.
		map.on("mouseleave", bati2DId, function() {
			map.setFilter(bati2DHId, ["==", "Id", ""]);
            popupBati.remove();

			});	

		map.addLayer({
	        id: etiqBati2DId,
	        type: "symbol",
	        source: {
	            type: "geojson",
	            data: "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/batiments_centroides.geojson"
	        },
			layout: {
		        "text-field": "{name}",
		        "text-anchor": "center",
		        "text-size":{'base': 1.4,'stops': [[13, 2], [22, 60]]}
    		},
    		minzoom : 14,
	    	});
		};


	
	function addCategoryOverlay(nomDeLaCouche,overlayCount,color,infoPopup,iconSize){
		var etiquette = false;
		var contenuPopup = infoPopup;
		for(var i = 0; i < Etiquette.length; i++){
			if (Etiquette[i]==nomDeLaCouche){
				etiquette = true;
				var nomDeLaCoucheEtiquette = nomDeLaCouche+'etiquette' 
			}
		}
		if (overlayCount === 0){
			map.addLayer({
		        id: nomDeLaCouche,
		        type: "circle",
		        source: {
		            type: "geojson",
		            data: "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/points.geojson"
		        },
		        filter : [ '==','Categorie',nomDeLaCouche],
		        layout: {'visibility': 'visible'}, 
				paint: {
			        "circle-radius": {'base': iconSize[0],'stops': [[iconSize[1],iconSize[2]], [iconSize[3], iconSize[4]]]},
			        "circle-color" : color,
			        "circle-opacity":0.9
					}
				});				
				Layers.push(nomDeLaCouche); 
			if (etiquette){
				overlayEtiquette = map.addLayer({
			        id: nomDeLaCoucheEtiquette,
			        type: "symbol",
			        source: {
			            type: "geojson",
			            data: "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/points.geojson"
			        },
			        filter : [ '==','Categorie',nomDeLaCouche],
			        layout: {
				        "text-field": "{Etiquette}",
				        "text-anchor": "center",
				        "text-size":{'base': 1.5,'stops': [[13, 2], [22, 60]]}, 
					},
					paint: {
						"text-color":"white"
						},
					minzoom:15.5
					});
				
				Layers.push(nomDeLaCoucheEtiquette); 
			}	
		} else {
			console.log(nomDeLaCoucheEtiquette);
			var visibility = map.getLayoutProperty(nomDeLaCouche,'visibility');
			if (visibility === 'visible') {
				map.setLayoutProperty(nomDeLaCouche,'visibility','none');
				popup.remove();
				if (etiquette){
					map.setLayoutProperty(nomDeLaCoucheEtiquette,'visibility','none');
					popup.remove();
	
				}
			} else {
				map.setLayoutProperty(nomDeLaCouche,'visibility','visible');
				map.setLayoutProperty(nomDeLaCoucheEtiquette,'visibility','visible')
				}
			};

			getPopup(contenuPopup,nomDeLaCouche);

			map.on('mousemove', function (e) {
				var features = map.queryRenderedFeatures(e.point, { layers: Layers });
				map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
			});
		}


function getPopup(infoPopup,couche){
	map.on('click', function (e) {
		var features = map.queryRenderedFeatures(e.point, { 
			layers: [couche] 
		});
		console.log(infoPopup)
		var popupTitle = null;
		var popupContent = [];

		if (!features.length) {
			return;
		}
		var feature = features[0];
		
		//Titre de la popup
		for(var i = 0; i < infoPopup.length; i++){ 
			if (infoPopup[i]=='Categorie'){
				popupTitle = feature.properties.Categorie;

			} 
		}
		for(var i = 0; i < infoPopup.length; i++){ 
			if (infoPopup[i]=='Nom'){
				popupTitle = feature.properties.Nom;
			} 
		}
		// Contenu de la popup
		for(var i = 0; i < infoPopup.length; i++){ 
			if (infoPopup[i]=='Batiment'){
				if (feature.properties.Batiment!== "null"){
					popupContent += '<p>Batiment '+feature.properties.Batiment;
				}
			} 
		}		
		for(var i = 0; i < infoPopup.length; i++){ 
			if (infoPopup[i]=='Niveau'){
				if (feature.properties.Niveau !== "null"){
					popupContent += ' '+feature.properties.Niveau;
				}
			} 
		}
		for(var i = 0; i < infoPopup.length; i++){ 
			if (infoPopup[i]=='Capacite'){
				if (feature.properties.Capacite !== "null"){
					popupContent += '<p>'+feature.properties.Capacite+'<p>';
				}
			} 
		}			
		for(var i = 0; i < infoPopup.length; i++){ 
			if (infoPopup[i]=='Info'){
				if (feature.properties.Info !== "null"){
					popupContent += '<p>'+feature.properties.Info+'<p>';
					console.log(feature.properties.Info);
				}
			} 
		}	
		for(var i = 0; i < infoPopup.length; i++){
			if (infoPopup[i]=='Lien'){
				if (feature.properties.Lien !== "null"){
					popupContent += '<p><a href = '+feature.properties.Lien+'>Site internet<a></p>';
				}
			} 
		}
		for(var i = 0; i < infoPopup.length; i++){
			if (infoPopup[i]=='Mail'){
				if (feature.properties.Mail !== "null"){
					popupContent += '<p>Contacter par mail : '+feature.properties.Mail+'</p>';
				}
			} 
		}
		for(var i = 0; i < infoPopup.length; i++){
			if (infoPopup[i]=='Tel'){
				if (feature.properties.Tel !== "null"){
					popupContent += '<p>Contacter par téléphone'+feature.properties.Tel+'</p>';
				}
			} 
		}		
		popup = new mapboxgl.Popup({ 
			offset: [0, -15],
			closeButton: false
		})
			.setLngLat(feature.geometry.coordinates)
			.setHTML('<h1>'+popupTitle+'</h1><p>'+popupContent+'</p>')
				.addTo(map);
		});	
}

var salleRecherchee = null

function createHTMLList(categorie,listeDeNoms,elementCible,overlayCount){
	salleRecherchee = null
	var listeLink = [];	
	elLink = null
	elList = null
	console.log(overlayCount)
	if (overlayCount == 0){
		var data = fproperties.filter(function(e){
			return e.Categorie === categorie;
		})
		for (i = 0; i < data.length; i++) {
			listeDeNoms.push(data[i]['Nom']);
		}			
	
		for (i = 0; i < listeDeNoms.length; i++){
			elList = document.createElement('li');
			elementCible.appendChild(elList);
			elLink = document.createElement('a');
			elLink.innerHTML = listeDeNoms[i];
			elLink.setAttribute('id',listeDeNoms[i]);
			elLink.setAttribute('href','#');
			var theFunction = 'javascript:switchPOI('+'\''+listeDeNoms[i].replace("'","!")+'\')'
			elLink.setAttribute('href',theFunction);
			elList.appendChild(elLink);
		}
		for (i = 0; i < listeDeNoms.length; i++){
		    listeLink.push(document.getElementById(listeDeNoms[i]))
		}
	}
}

// Fonctions pour zoomer sur l'item sélectionné dans la liste

function getSwitchPopup(){

	var popupTitle = null;
	var popupContent = '';
	
	if (salleRecherchee.properties.Categorie !== null){
		popupTitle = salleRecherchee.properties.Categorie;
	}	
	if (salleRecherchee.properties.Nom !== null){
		popupTitle = salleRecherchee.properties.Nom;
	}
	if (salleRecherchee.properties.Batiment !== null){
		popupContent += '<p>Batiment '+salleRecherchee.properties.Batiment;
	}	
	if (salleRecherchee.properties.Niveau !== null){
		popupContent += ' '+salleRecherchee.properties.Niveau;
	}	
	if (salleRecherchee.properties.Capacite !== null){
		popupContent += '<p>'+salleRecherchee.properties.Capacite+'<p>';
	}
	if (salleRecherchee.properties.Info !== null){
		popupContent += '<p>'+salleRecherchee.properties.Info+'<p>';
	}
	if (salleRecherchee.properties.Lien !== null){
		popupContent += '<p><a href = '+salleRecherchee.properties.Lien+'>Site internet<a></p>';
	}
	if (salleRecherchee.properties.Mail !== null){
		popupContent += '<p>Contacter par mail : '+salleRecherchee.properties.Mail+'</p>';
	}
	if (salleRecherchee.properties.Tel !== null){
		popupContent += '<p>Contacter par téléphone'+salleRecherchee.properties.Tel+'</p>';
	}
    popupList = new mapboxgl.Popup({
        offset:[0,-15],
        closeButton: false
	})
    .setLngLat(salleRecherchee.geometry.coordinates)
    .setHTML('<h1>'+popupTitle+'</h1><p>'+popupContent+'</p>')
        .addTo(map);
};

function switchPOI(value){
	console.log(value);
	value = value.replace("!","'");
	salleRecherchee = null;
	salleRX = null;
	salleRY = null;

	if (popup){
		popup.remove();
	}
	if (popupList){
		popupList.remove();
	}

	for(var i = 0; i < POI.length; i++){
		
		if (POI[i].properties.Nom === value){
		    salleRecherchee = POI[i];
		    }}
	salleRX = salleRecherchee.geometry.coordinates[0];
	salleRY = salleRecherchee.geometry.coordinates[1];

	if (salleRecherchee.properties.Campus === 'Mazier'){
		map.setMaxBounds(mazierBounds);
	} else {
		map.setMaxBounds(rennesBounds);
	};
	if (DDD){					
		map.flyTo({
    		center:[salleRX,salleRY],
    		zoom:16.5,
    		pitch:45,
			speed:0.6
    	});
    } else {
    	map.flyTo({
    		center:[salleRX,salleRY],
    		zoom:16.5,
    		pitch:0,
			speed:0.6
    	});	        	
    }
	getSwitchPopup();
	} 

//////////////////////////////////   Interactivité menus //////////////////////////////////////

	// ZOOMS sur les campus
 	var zoomLaHarpe = document.getElementById("LaHarpe")
    zoomLaHarpe.addEventListener('click', function(){
        map.setMaxBounds(rennesBounds);
		map.flyTo({
            zoom:16,
            center:[-1.7091, 48.1254]
        });
        zoomLaHarpe.style.backgroundColor = '#286090';
        zoomVillejean.style.backgroundColor = 'grey';
        zoomMazier.style.backgroundColor = 'grey'

    });

    var zoomVillejean = document.getElementById("Villejean")
    zoomVillejean.style.backgroundColor = '#286090';

    zoomVillejean.addEventListener('click', function(){
        map.setMaxBounds(rennesBounds);
		map.flyTo({
            zoom:16,
            center:[-1.7013, 48.119365]
        });
        zoomVillejean.style.backgroundColor = '#286090';
        zoomMazier.style.backgroundColor = 'grey';
        zoomLaHarpe.style.backgroundColor = 'grey';
    });

    var zoomMazier = document.getElementById("Mazier")
    zoomMazier.addEventListener('click',function(){
        map.setMaxBounds(mazierBounds);
		map.flyTo({
            zoom:16,
            center:[-2.7410000,48.513033]
        });
        zoomMazier.style.backgroundColor = '#286090';
        zoomVillejean.style.backgroundColor = 'grey';
        zoomLaHarpe.style.backgroundColor = 'grey';
    });
//////////////////////////////////   Initialisation des données carte //////////////////////////////////////




var POIBrut = (function (){
var json = null;

$.ajax({
	'async':false,
	'global':false,
	'url' : "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/points.geojson",
	'dataType' : "json",
	'success' : function(data){
		json = data;
	}
		});
	return json;
})();

var POI = []; 
POI = POIBrut.features; 
	
var fproperties = POIBrut.features.map(function (el) {
	return el.properties; 
});		


map.on("load", function() {
	// Couche herbe
    map.addLayer({
        id: "Herbe",
        type: "fill",
        source: {
            type: "geojson",
            data: "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/grass.geojson"
        },
        paint: {
        	'fill-color': '#A4E463',
        	'fill-opacity':0.5
			}
    	});
	
	// Couche référentiel bati 2D
	getBati2D();	
	
	// Couche piste athletisme
	map.addLayer({
	    id: "Piste d'athlétisme Villejean",
        type: "fill",
        source: {
            type: "geojson",
            data: "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/piste_athle.geojson"
        },
        paint: {
        	'fill-color': '#C09C83',
        	'fill-opacity':0.85
		}
	});
	map.addLayer({
        id: "Terrain de football Villejean",
        type: "line",
        source: {
            type: "geojson",
            data: "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/terrain_football.geojson"
        },
        "paint": {
            'line-color': '#FFFFFF',
            'line-width' : {'base': 1.2,'stops': [[13, 0.5], [22, 3]]}
            }
        });
	//Etiquettes campus
	map.addLayer({
        id: "Etiquette Campus",
        type: "symbol",
        source: {
            type: "geojson",
            data: "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/points.geojson"
        },
        filter : [ '==','Categorie','Bâtiments'],
		layout: {
	        "text-field": "{Etiquette}",
	        "text-anchor": "center",
	        "text-size":11
		},
		maxzoom : 14,
    });
 

	
//////////////////////////////////   OVERLAYS //////////////////////////////////////


	amphitheatresLink.onclick = function(e){
		addCategoryOverlay('Amphithéâtre',amphiCount,amphiColor,amphiInfoPopup,amphiIconSize);
		amphiCount += 1;
	}
	
	sallesInfoLink.onclick = function(e){
		addCategoryOverlay('Salle informatique',sallesInfoCount,sallesInfoColor,sallesInfoInfoPopup,sallesInfoIconSize);
		sallesInfoCount += 1;
	}

	toilettesLink.onclick = function(e){
		addCategoryOverlay('Toilettes',toilettesCount,toilettesColor,toilettesInfoPopup,toilettesIconSize);
		toilettesCount += 1;
	}

	copieurLink.onclick = function(e){
		addCategoryOverlay('Copieur',copieurCount,copieurColor,copieursInfoPopup,copieursIconSize);
		copieurCount += 1;
	}

	sallesSpecifiquesLink.onclick = function(e){
		addCategoryOverlay('Salles spécifiques',sallesSpeCount,sallesSpeColor,sallesSpeInfoPopup,sallesSpeIconSize);
		if (sallesSpeCount==0){
			createHTMLList('Salles spécifiques',listeSallesSpecifiques,insertSallesSpecifiques,sallesSpeCount);
		}
		sallesSpeCount +=1;
	}

	lieuCulturelLink.onclick = function(e){
		addCategoryOverlay('Lieu culturel',lieuCulturelCount,lieuCulturelColor,lieuCulturelInfoPopup,lieuCulturelIconSize);
		if (lieuCulturelCount==0){
			createHTMLList('Lieu culturel',listelieuCulturel,insertLieuCulturel,lieuCulturelCount);
		}
		lieuCulturelCount += 1;
	}
	equipementSportifLink.onclick = function(e){
		addCategoryOverlay('Equipement sportif',equipementSportifCount,equipementSportifColor,equipementSportifInfoPopup,equipementSportifIconSize);
		equipementSportifCount += 1;
	}
	espaceDetenteLink.onclick = function(e){
		addCategoryOverlay('Espace détente',espaceDetenteCount,espaceDetenteColor,espaceDetenteInfoPopupespaceDetenteIconSize);
		espaceDetenteCount += 1;
	}

	cafeteriasLink.onclick = function(e){
		addCategoryOverlay('Cafétéria',cafeteriasCount,cafeteriasColor,cafeteriasInfoPopup,cafeteriasIconSize);
		cafeteriasCount += 1;
	}

	associationsLink.onclick = function(e){
		addCategoryOverlay('Associations',associationsCount,associationsColor,associationsInfoPopup,associationsIconSize);
		associationsCount += 1;
	}

	ascenseurLink.onclick = function(e){
		addCategoryOverlay('Ascenseur',ascenseurCount,ascenseurColor,ascenseurInfoPopup,ascenseurIconSize);
		ascenseurCount += 1;
	}

	parkingLink.onclick = function(e){
		addCategoryOverlay('Parking',parkingCount,parkingColor,parkingInfoPopup,parkingIconSize);
		parkingCount += 1;
	}
	parkingPMRLink.onclick = function(e){
		addCategoryOverlay('Parking PMR',parkingPMRCount,parkingPMRColor,parkingPMRInfoPopup,parkingPMRIconSize);
		parkingPMRCount += 1;
	}
	parkingVeloLink.onclick = function(e){
		addCategoryOverlay('Parking vélo',parkingVeloCount,parkingVeloColor,parkingVeloInfoPopupparkingVeloIconSize);
		parkingVeloCount += 1;
	}
});

//////////////////////////////////// couches temps réel //////////////////////////////////////////////

// Velostar 


var geojsonVelos = null;
var previousDataVelos = { times: [], stations: [] };
var prevInfo = null;
var velostarCount = 0
var nomLayer= null
var velostarLink = document.getElementById('Stations vélostar');
velostarLink.onclick = function (e) {
    velostarCount +=1 ;
    if (velostarCount === 1){
        updateData();
        function updateData() {
            //Appel de l'API pour les vélos
            $.ajax({
                //URL de l'API
                url: "https://data.explore.star.fr/api/records/1.0/search/?dataset=vls-stations-etat-tr&facet=nom&facet=etat&facet=nombreemplacementsactuels&facet=nombreemplacementsdisponibles&facet=nombrevelosdisponibles&format=geojson&rows=150",
                
                //Type de données
                dataType: "jsonp",
                crossDomain: true,
                
                //Méthode appelée lorsque le téléchargement a fonctionné
                success: function(geojson) {
                    console.log("Données téléchargées");
                    geojsonVelos = geojson;
                    saveBikeData();
                    if (nomLayer === null) {
                        showBikeData()
                    } else {
                        var visibility = map.getLayoutProperty(nomLayer,'visibility');
                        if (visibility === 'visible'){
                            showBikeData()
                        } else {
                            console.log('données masquées')
                        }
                    };
                    setTimeout(updateData, 60*1000);
                },
                
                //Méthode appelée lorsque le téléchargement a échoué
                error: function() {
                    alert("Erreur lors du téléchargement des vélos !");
                }      
            });
        };

        function saveBikeData() {
            //On change la structure des données pour simplifier l'utilisation
            var stations = {};
            var prevStationData = null;
            geojsonVelos.features.forEach(f => {
                stations[f.properties.nom] = f.properties;
                
                //On compare avec le nombre de vélos précédent
                if(previousDataVelos.stations.length > 0) {
                    f.properties.diff = f.properties.nombrevelosdisponibles - previousDataVelos.stations[previousDataVelos.stations.length-1][f.properties.nom].nombrevelosdisponibles;
                }
                else {
                    f.properties.diff = 0;
                }
                
                //On met à jour l'affichage des infos si besoin
                if(prevInfo && prevInfo === f.properties.nom) {
                    prevStationData = f;
                }
            });
            
            previousDataVelos.times.push(Date.now());
            previousDataVelos.stations.push(stations);
            Layers = Layers.filter(item => item != "bikes"+(previousDataVelos.times.length-1));

        }
        function showBikeData() {
            //On supprime les données précédentes
            if(previousDataVelos.times.length > 1) {
                map.removeLayer("bikes"+(previousDataVelos.times.length-1));
            }
            
            //On créé un nouveau calque de données
            nomLayer = "bikes"+previousDataVelos.times.length;
            Layers.push(nomLayer);

            map.addLayer({
                id: nomLayer,
                type: "circle",
                source: {
                    type: "geojson",
                    data: geojsonVelos
                },
                filter: ["has", "diff"],
                paint: {
                    "circle-radius": {'base': 1.5,'stops': [[13, 5], [22, 60]]},
                    "circle-color": "green"
                }
            });
        }       

    } else {
        var clickedLayer = this.textContent;
        e.preventDefault();
        e.stopPropagation();
        var visibility = map.getLayoutProperty(nomLayer,'visibility');
        if (visibility === 'visible') {
            map.setLayoutProperty(nomLayer,'visibility','none');
            Layers = Layers.filter(item => item != nomLayer);
        } else {
            map.setLayoutProperty(nomLayer,'visibility','visible');
            Layers.push(nomLayer);
            }
    };
        
    map.on('click', function (e) {
        var features = map.queryRenderedFeatures(e.point, { 
            layers: [nomLayer] 
        });
        if (!features.length) {
            return;
        }
        var feature = features[0];
        popup = new mapboxgl.Popup({ 
            offset: [0, -15],
            closeButton: false,
        })
            .setLngLat(feature.geometry.coordinates)
            .setHTML('<h1> Station vélostar : '+feature.properties.nom+'</h1><p>Nombre de vélos disponibles : '+feature.properties.nombrevelosdisponibles+'<br>Nombre d\'emplacements disponibles : ' +feature.properties.nombreemplacementsdisponibles+'</p>')
                .addTo(map);
        });
        map.on('mousemove', function (e) {
            var features = map.queryRenderedFeatures(e.point, { layers: Layers });
            map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
        });    
    }


// Couche des BUS


var geojsonBus = null;
var previousDataBus = { times: [], stations: [] };
var prevInfo = null;
var busCount = 0
var nomLayerBus= null
var busLink = document.getElementById('Réseau de bus');
busLink.onclick = function (e) {
    busCount +=1;
    if (busCount === 1){
        updateBusData();
        function updateBusData() {
            //Appel de l'API pour les vélos
            $.ajax({
                //URL de l'API
                url: "https://data.explore.star.fr/api/records/1.0/search/?dataset=tco-bus-vehicules-position-tr&facet=numerobus&facet=etat&facet=nomcourtligne&facet=sens&facet=destination&facet=ecartsecondes&format=geojson&rows=500",
                
                //Type de données
                dataType: "jsonp",
                crossDomain: true,
                
                //Méthode appelée lorsque le téléchargement a fonctionné
                success: function(geojson) {
                    console.log("Données téléchargées");
                    geojsonBus = geojson;
                    saveBusData();
                    if (nomLayerBus === null) {
                        showBusData()
                    } else {
                        var visibility = map.getLayoutProperty(nomLayerBus,'visibility');
                        if (visibility === 'visible'){
                            showBusData()
                        } else {
                            console.log('données masquées')
                        }
                    };
                    setTimeout(updateBusData, 60*1000);
                },
                
                //Méthode appelée lorsque le téléchargement a échoué
                error: function() {
                    alert("Erreur lors du téléchargement des bus !");
                }      
            });
        };


        function saveBusData() {
            //On change la structure des données pour simplifier l'utilisation
            var stations = {};
            var prevStationData = null;
            
            
            previousDataBus.times.push(Date.now());
            previousDataBus.stations.push(stations);
            Layers = Layers.filter(item => item != "bus"+(previousDataBus.times.length-1));

        }
        function showBusData() {
            //On supprime les données précédentes
            if(previousDataBus.times.length > 1) {
                map.removeLayer("bus"+(previousDataBus.times.length-1));
            }
            
            //On créé un nouveau calque de données
            nomLayerBus = "bus"+previousDataBus.times.length;
            Layers.push(nomLayerBus);

            map.addLayer({
                id: nomLayerBus,
                type: "circle",
                source: {
                    type: "geojson",
                    data: geojsonBus
                },
                filter : [ '==','etat','En ligne'],                
                paint: {
                    "circle-radius": {'base': 1.7,'stops': [[13, 5], [22, 60]]},
                    "circle-color": "#0066ff"
                }
            });
        }       
        busCount +=1;

    } else {
        var clickedLayer = this.textContent;
        e.preventDefault();
        e.stopPropagation();
        var visibility = map.getLayoutProperty(nomLayerBus,'visibility');
        if (visibility === 'visible') {
            map.setLayoutProperty(nomLayerBus,'visibility','none');
            Layers = Layers.filter(item => item != nomLayerBus);
        } else {
            map.setLayoutProperty(nomLayerBus,'visibility','visible');
            Layers.push(nomLayerBus);
            }
    };
        
    map.on('click', function (e) {
        var features = map.queryRenderedFeatures(e.point, { 
            layers: [nomLayerBus] 
        });
        if (!features.length) {
            return;
        }
        var feature = features[0];
        popup = new mapboxgl.Popup({ 
            offset: [0, -15],
            closeButton: false,
        })
            .setLngLat(feature.geometry.coordinates)
            .setHTML('<h1> Bus du réseau STAR </h1><p>Ligne : '+feature.properties.nomcourtligne+'<br>A destination de : '+feature.properties.destination+'</p>')
                .addTo(map);
        });
        map.on('mousemove', function (e) {
            var features = map.queryRenderedFeatures(e.point, { layers: Layers });
            map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
        });    
    }
	

//////////////////////////////////  Barre de recherche //////////////////////////////////////
	
	// initialisation des popup
	var searchPopup = null

	var jproperties = fproperties.filter(function(e){
		return e.Nom !== null;
	})
	// Récupération des propriétés du json

	var searchValue	= null;
	var searchItem = [];
	var searchX = null;
	var searchY = null;
	var searchLayerCount = 0;
	var searchLayerId = 'SearchResult';
	var searchPopup = null

	var options = {
	    data: jproperties,
	    getValue: "Nom",
	    template: {
	        type: "description",
	        fields: {
	        // Possibilité de mettre le campus en description
	            description: "Campus"
	        }
	    },
	    list: {
	        match: {
	            enabled: true
	        }
	    },
	    theme: "plate-dark"
	};
	$("#searchfield").easyAutocomplete(options);		
    
    function getSearchPopup(){
        var popupTitle = searchItem.properties.Nom;
        var popupContent = '';
        if (searchItem.properties.Image != null  ){
			popupContent += '<img src = \''+ searchItem.properties.Photo+'\'/>';
        };

        if (searchItem.properties.Batiment != null ){
			popupContent += '<p>Batiment '+searchItem.properties.Batiment;
        };
        if (searchItem.properties.Niveau != null){
			popupContent += ' '+searchItem.properties.Niveau;
        };
        if (searchItem.properties.Info != null ){
			popupContent += '<p>'+searchItem.properties.Info+'<p>';
        };
        if (searchItem.properties.Capacite != null){
			popupContent += '<p>'+searchItem.properties.Capacite+'<p>';
        };
        if (searchItem.properties.Lien != null ){
			popupContent += '<p><a href = '+searchItem.properties.Lien+'>Site internet<a></p>';
        };
        if (searchItem.properties.Mail != null ){
			popupContent += '<p>Contacter par mail : '+searchItem.properties.Mail+'</p>';
        };
        if (searchItem.properties.Tel != null ){
			popupContent += '<p>Contacter par téléphone : '+searchItem.properties.Tel+'</p>';
        };





        searchPopup = new mapboxgl.Popup({
            offset:[0,-15],
            closeButton: false
    })
        .setLngLat(searchItem.geometry.coordinates)
        .setHTML('<h1>'+popupTitle+'</h1><p>'+popupContent+'</p>')
            .addTo(map);
    };	




	function getSearchedItem(){
		if (searchValue !==null){
	    		searchValue = null
				searchItem = [];
				searchX = null;
				searchY = null;
                Layers = Layers.filter(item => item != searchLayerId);
				searchLayerCount+=1;
				searchPopup.remove();
				map.removeLayer(searchLayerId)
				searchLayerId = 'searchResult'+searchLayerCount;
	    	};

	        searchValue = document.getElementById("searchfield").value;
			for(var i = 0; i < POI.length; i++){
	        	if (POI[i].properties.Nom === searchValue){
	        		searchItem = POI[i];
	        		map.addLayer({
	        			id: searchLayerId,
	        			type:'circle',
	        			source:{
	        				type:"geojson",
	        				data: searchItem
	        			},
	        			layout:{'visibility':'visible'},
	        			paint:{
					        "circle-radius": {'base': 1.5,'stops': [[13, 2], [22, 60]]},
					        "circle-color" :'#FF0000',
					        "circle-opacity":0.9
	        			}
	        		});
	        	Layers.push(searchLayerId);

                map.on('mousemove', function (e) {
                    var features = map.queryRenderedFeatures(e.point, { layers: Layers });
                    map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
                });
	        	searchX = searchItem.geometry.coordinates[0];
	        	searchY = searchItem.geometry.coordinates[1];
				if (POI[i].properties.Campus === 'Mazier'){
					map.setMaxBounds(mazierBounds);
					zoomVillejean.style.backgroundColor = 'grey';
			        zoomMazier.style.backgroundColor = '#286090';
			        zoomLaHarpe.style.backgroundColor = 'grey';
				} 
				if (POI[i].properties.Campus === 'Villejean'){
					map.setMaxBounds(rennesBounds);
					zoomVillejean.style.backgroundColor = '#286090';
			        zoomMazier.style.backgroundColor = 'grey';
			        zoomLaHarpe.style.backgroundColor = 'grey';
				} 
				if (POI[i].properties.Campus === 'La Harpe'){
					map.setMaxBounds(rennesBounds);
					zoomVillejean.style.backgroundColor = 'grey';
			        zoomMazier.style.backgroundColor = 'grey';
			        zoomLaHarpe.style.backgroundColor = '#286090';
				} 


				if (DDD){					
					map.flyTo({
		        		center:[searchX,searchY],
		        		zoom:16.5,
		        		pitch:45,
						speed:0.6
		        	});
		        } else {
		        	map.flyTo({
		        		center:[searchX,searchY],
		        		zoom:16.5,
		        		pitch:0,
						speed:0.6
		        	});	        	
		        }

                getSearchPopup();
	        	map.on('click',function (e){
                    if (searchPopup.isOpen() == true){
                        searchPopup.remove();
                    
                    }
	        	})
            }
        }
	}
function runScriptKey(e) {
    if (e.keyCode == 13) {
    	console.log('ok');
    	getSearchedItem();
    }
}
function runScriptClic(e){
	getSearchedItem();
}
	

	
//////////////////////////////////   3D   //////////////////////////////////////

document.getElementById('DDD').addEventListener('click',function(){
	var X = map.getCenter()["lng"];
	var Y = map.getCenter()["lat"];
	var button = document.getElementById('DDDButton');
	if (DDD===false){
		getBati3D();
		map.flyTo({
			center:[X,Y],
			pitch:45,
			speed:0.1
		});
		button.style.backgroundColor = '#286090';
		DDD=true;
		map.dragRotate.enable();
	} else {
		getBati2D();
		map.flyTo({
			center:[X,Y],
			pitch:0,
			bearing:0,
			speed:0.1
		});	
		button.style.backgroundColor = 'grey';
		DDD=false;	
		map.dragRotate.disable();
	}
})

//////////////////////////////////   Ajout de l'habillage de la carte //////////////////////////////////////

var nav = new mapboxgl.NavigationControl();
map.addControl(nav, 'top-left');

map.addControl(new mapboxgl.ScaleControl({
maxWidth: 120,
unit: 'metric'}));

</script>
</body>
</html>
