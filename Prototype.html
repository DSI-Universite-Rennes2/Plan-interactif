<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Prototype Mapbox GL</title>

    <!-- API MAPBOX GL-->
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.0/mapbox-gl.css' rel='stylesheet' />

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom Fonts -->
    <link href="css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="css/startmin.css" rel="stylesheet">
	
	<!-- JQUERY  -->
	<script src="https://code.jquery.com/jquery-1.11.2.js"
  integrity="sha256-WMJwNbei5YnfOX5dfgVCS5C4waqvc+/0fV7W2uy3DyU="
  crossorigin="anonymous"></script>
	
	<!-- Stylesheet for search box -->
	<link rel="stylesheet" href="EasyAutocomplete-1.3.5/easy-autocomplete.min.css"> 

	<!-- library for search box -->
	<script src= "EasyAutocomplete-1.3.5/jquery.easy-autocomplete.min.js"></script> 
	
	<!-- Bootstrap Core JavaScript -->
	<script src="js/bootstrap.min.js"></script>
	<!-- Metis Menu Plugin JavaScript -->
	<script src="js/metisMenu.min.js"></script>
	<!-- Custom Theme JavaScript -->
	<script src="js/startmin.js"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>
<body>

<div id="wrapper">

    <!-- Navigation -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation" >
	<!-- Gestion du menu de couches -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>

        <!-- Sidebar -->
        <div class="navbar-default sidebar" role="navigation">
            <div class="sidebar-nav navbar-collapse">

	<!-- Search bar -->
		    
			<ul class="nav" id="side-menu">

				<li class="sidebar-search">
					<div class="input-group custom-search-form">
						<input id= "searchfield" type="text" placeholder="Rechercher..." onkeypress="return runScriptKey(event)">
							<span class="input-group-btn">
								<button class="btn btn-primary" id = "searchButton" type="button" onclick = "return runScriptClic(event)">
									<i class="fa fa-search" ></i>
								</button>
							</span>					
					</div>
				</li>

        		<!-- Gestion des couches -->

				<li>
				   <a href="#">Zoomer sur un campus<span class="fa arrow"></span></a>
        			<ul class="nav nav-second-level">
        				<li>
        					<a href="#" id = "Villejean">Villejean</a>
        				</li>
        				<li>
        					<a href="#" id = "LaHarpe">La Harpe</a>
        				</li>
        				<li>
        					<a href="#" id = "Mazier">Mazier (St Brieuc)</a>
        				</li>                            
        			</ul>						
				</li>                    


		    	<li>
                	<a href="#">Amphis et salles spécifiques<span class="fa arrow"></span></a>
                        <ul class="nav nav-second-level">
                            <li>
                                <a href="#" id = "Amphithéâtres">Amphithéâtres</a>
                            </li>
                            <li>
                                <a href="#" id = "Salles spécifiques">Salles spécifiques</a>
                            </li>
                            <li>
                                <a href="#" id = "Salles informatique">Salles informatique</a>
                            </li>
                            <!--
                            <li>
                                <a href="#">Salles des conseils</a>
                            </li>                            
                            <li>
                                <a href="#">Salle Jacques Léonard</a>
                            </li>
                            <li>
                                <a href="#">Salle Pina Bausch</a>
                            </li>
                            <li>
                                <a href="#">Salles Kennedy</a>
                            </li>
                            <li>
                                <a href="#">...</a>
                            </li>
                            -->
                        </ul>
                    </li>
					<li>
                        <a href="#">Scolarité et Administration<span class="fa arrow"></span></a>
                        <ul class="nav nav-second-level">
                            <li>
                                <a href="#" id = "Scolarités">Scolarités</a>
                            </li>
                            <li>
                                <a href="#" id ="Secrétariats">Secrétariat</a>
                            </li>
                        </ul>
                    </li>


		    		<li>
                        <a href="#">Bibliothèques et Culture<span class="fa arrow"></span></a>
                        <ul class="nav nav-second-level">
                            <li>
                                <a href="#" id = "Bibliothèques">Bibliothèques</a>
                            </li>
                            <li>
                                <a href="#" id = "Lieux culturels">Lieux culturels</a>
                            </li>
                            <!--
                            <li>
                                <a href="#">Galerie arts et essais</a>
                            </li>
                            -->                            
                        </ul>
                    </li>


				 	<li>
                        <a href="#">Restauration et logement<span class="fa arrow"></span></a>
                        <ul class="nav nav-second-level">
                            <li>
                                <a href="#" id = "Restaurants universitaires">Restaurants universitaires</a>
                            </li>
                            <li>
                                <a href="#" id = "Caféterias">Caféterias</a>
                            </li>
                            <li>
                                <a href="#" id = "Machines à café">Machines à café</a>
                            </li>
                            <li>
                                <a href="#" id = "Résidences universitaires">Résidences universitaires</a>
                            </li>                            
                        </ul>
                    </li>


		    		<li>
                        <a href="#">Sport et santé<span class="fa arrow"></span></a>
                        <ul class="nav nav-second-level">
                            <li>
                                <a href="#" id = "Equipements sportifs">Equipements sportifs</a>
                            </li>
                            <li>
                                <a href="#" id = "Pole santé">Pole santé</a>
                            </li>
                        </ul>
                    </li>


                    <li>
                        <a href="#">Vie associative<span class="fa arrow"></span></a>
                        <ul class="nav nav-second-level">
                            <li>
                                <a href="#" id = "Associations">Associations</a>
                            </li>
                            <li>
                                <a href="#" id = "Ressourcerie">Ressourcerie</a>
                            </li>
                            <li>
                                <a href="#" id = "Le potager">Le potager</a>
                            </li>

                        </ul>
                    </li>


                    <li>
                        <a href="#">Services divers<span class="fa arrow"></span></a>
                        <ul class="nav nav-second-level" >
                            <li>
                                <a href="#" id = "Toilettes">Toilettes</a>
                            </li>

                            <li>
                                <a href="#" id = "Copieurs">Copieurs</a>
                            </li>
                        </ul>
                    </li>


                    <li>
                        <a href="#">Mobilités et accessibilité<span class="fa arrow"></span></a>
                        <ul class="nav nav-second-level">
                            <li>
                                <a href="#">Se déplacer sur le campus <span class="fa arrow"></span></a>
                                <ul class="nav nav-third-level">
                                    <li>
                                    	<a href="#" id= "Ascenceurs">Ascenceurs</a>
                                    </li>
                                    <li>
                                        <a href="#" id = "Escaliers">Escaliers</a>
                                    </li>
                                    <li>
                                        <a href="#" id = "Accès PMR">Accès PMR</a>
                                    </li>
                                    <li>
                                        <a href="#" id = "Cheminements accessibles">Cheminements accessibles</a>
                                    </li>                                                                                                             
                                </ul>
                            </li>

                            <li>
                                <a href="#">Accéder au campus <span class="fa arrow"></span></a>
                                <ul class="nav nav-third-level">
                                    <li>
                                        <a href="#" id = "Réseau de bus">Réseau de bus</a>
                                    </li>
                                    <li>
                                        <a href="#" id = "Métro">Métro</a>
                                    </li>
                                    <li>
                                        <a href="#" id = "Stations vélostar">Stations vélostar</a>
                                    </li>
                                    <li>
                                        <a href="#" id = "Parkings">Parkings</a>
                                    </li>
                                    <li>
                                        <a href="#" id = "Places handicapés">Places handicapés</a>
                                    </li>                                                                                                                                                   
                                </ul>
                            </li>	
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

     <div id="page-wrapper" style = "padding:0">
        <div class="container-fluid" style = "padding-left:0;
					      padding-right:0;
					      padding-top : 0;
					      padding-bottom : 0;
					      margin-right: 0;
					      margin-top : 0;
					      margin-left: :0;
					      margin-bottom : 0">

            <div class="row">
                <div class="col-lg-12"></div>
            </div>

         	<div id="map" style="position:relative;
				 margin-top:50px;
				 margin-right:0;
				 margin-left:0;
				 margin-bottom:0;
				 padding-right : 0;
				 padding-left : 0; 
				 padding-top:0;
				 padding-bottom:0;
				 z-index:1;
			     height:90vh">
				<div id="DDD" class="btn-group">
					<button  class="btn btn-primary" id="DDDButton">3D</button>
 				</div>	 
			</div>
    	</div>
    </div>
</div>



<script>
	
//////////////////////////////////   Initialisation de variables //////////////////////////////////////
	
	
	//Limites de vue en fonction du campus visité
	//Villejean / La Harpe
	var rennesBounds = [
    [-1.787293,48.067191 ], // Southwest coordinates
    [-1.525772,48.169255 ]  // Northeast coordinates
	];
	
	//Mazier
	var mazierBounds = [
	[-2.810090, 48.488519],
	[-2.668165,48.534886]
	];
	
	//Variables nécessaires à la fonctionnalité de changement de vue (2D -> 3D)
	var DDD = false; // Vue de base en 2D
	var bati2DId = 'bati2DId'; // Identifiant de la couche de bati 2D
	var bati2DCount = 0; // Nombre de fois que la couche de bati 2D a été appelée (< nécessité de changer d'identifiant)
	var bati3DId = 'bati3dId';  // Identifiant de la couche de bati 3D
	var bati3DCount = 0; // Nombre de fois que la couche de bati 3D a été appelée
	var bati2DHId = 'bati2DHId'; // idem couche hover
	var bati3DHId = 'bati3dHId'; // idem couche hover
	var etiqBati2DId = 'etiqBati2DId'; // idem couche etiquette
	var etiqBati3DId = 'etiqBati3DId'; // idem couche etiquette
	
	// initialisation des popup
	var searchPopup = null
    var popupBati = new mapboxgl.Popup({
        closeButton: false,
        closeOnClick: false
        });
	var popup = null

	// Initialisation des variables d'overlay
	var Layers = [];
	var sallesInfoCount = 0;
	var amphisCount = 0;
	
	// initialisation du fond de carte 
    var map = new mapboxgl.Map({
        container: 'map', // container id
        style: 'https://free.tilehosting.com/styles/basic/style.json?key=nWBK7ixdxgsIG534xdet', // stylesheet location
        center: [-1.7013, 48.119365], // starting position [lng, lat]
        zoom: 15.8,
		minZoom:13, // zoom minimal
        pitch : 0, // inclinaison de base
		maxBounds: rennesBounds // starting zoom
    });

	map.dragRotate.disable(); // vue 2D de base 
	
//////////////////////////////////   Creation de fonctions //////////////////////////////////////
	
	// Fonction pour afficher le référentiel bati 3D
	function getBati3D(){
		if (bati3DCount != 0){
			map.removeLayer(bati2DId); 
			map.removeLayer(bati2DHId);
			map.removeLayer(etiqBati2DId);		
		};
		bati3DCount += 1;
		bati3DId = 'bati3DId'+bati3DCount;
		bati3DHId = 'bati3DHId'+bati3DCount;
		etiqBati3DId = 'etiqBati3DId' + bati3DCount;
		map.addLayer({
			id: bati3DId,
			type: "fill-extrusion",
			source: {
				type: "geojson",
				data:  "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/villejean_bati_height.geojson"
			},
			paint: {
				'fill-extrusion-color': '#d1d1e0', 
				'fill-extrusion-height':{
					'type': 'identity',
					'property': 'hauteur'
				},
				'fill-extrusion-base': {
					'type': 'identity',
					'property': 'hauteur_mi'},
				'fill-extrusion-opacity': 0.8
			}
		},Layers[0]);
		map.addLayer({
			id: bati3DHId,
			type: "fill-extrusion",
			source: {
				type: "geojson",
				data:  "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/villejean_bati_height.geojson"
			},
			filter: ["==", "id", ""],

			paint: {
				'fill-extrusion-color': '#D82B09', 
				'fill-extrusion-height':{
					'type': 'identity',
					'property': 'hauteur'
				},
				'fill-extrusion-base': {
					'type': 'identity',
					'property': 'hauteur_mi'},
				'fill-extrusion-opacity': 0.8
			}
		},Layers[0]);
		map.on("mousemove", bati3DId, function(e) {

			map.setFilter(bati3DHId, ["==", "id", e.features[0].properties.id]);
            if (popupBati!==null){popupBati.remove();}
            if ((popup == null || popup.isOpen()==false)  && (searchPopup == null || searchPopup.isOpen() ===false)){
                popupBati = new mapboxgl.Popup({ 
                    offset: [0, -15],
                    closeButton: false
                })
                    .setLngLat(e.lngLat)
                    .setHTML('<h1>'+e.features[0].properties.id+'</h1>')
                        .addTo(map);
                }
            });
            
		
            
                          
		// Reset the state-fills-hover layer's filter when the mouse leaves the layer.
		map.on("mouseleave", bati3DId, function() {
			map.setFilter(bati3DHId, ["==", "id", ""]);
            popupBati.remove();
		});	

		map.addLayer({
	        id: etiqBati3DId,
	        type: "symbol",
	        source: {
	            type: "geojson",
	            data: "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/batiments_centroides.geojson"
	        },
			layout: {
		        "text-field": "{name}",
		        "text-anchor": "center",
		        "text-size":{'base': 1.4,'stops': [[13, 2], [22, 60]]}
    		},
    		minzoom : 14,
	    });

	};

	// Fonction pour afficher le référentiel bati 2D
	function getBati2D(){
		if (bati3DCount != 0){
			map.removeLayer(bati3DId);
			map.removeLayer(bati3DHId);
			map.removeLayer(etiqBati3DId);		
		};
		bati2DCount += 1;
		bati2DId = 'bati2DId'+bati2DCount;
		bati2DHId = 'bati2DHId'+bati2DCount;
		etiqBati2DId='etiqBati2DId' + bati2DCount;
		map.addLayer({
			id: bati2DId,
			type: "fill",
			source: {
				type: "geojson",
				data: "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/batiments.geojson"
			},
			paint: {
				'fill-color': '#9494b8',
				'fill-opacity':0.8
			}
		},Layers[0]);
		map.addLayer({
			id: bati2DHId,
			type: "fill",
			source: {
				type: "geojson",
				data: "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/batiments.geojson"
			},
			filter: ["==", "id", ""],
			paint: {
				'fill-color': '#D82B09',
				'fill-opacity':0.5
			}
		},Layers[0]);
		map.on("mousemove", bati2DId, function(e) {
			map.setFilter(bati2DHId, ["==", "id", e.features[0].properties.id]);
            if (popupBati!==null){
                popupBati.remove();
            };
            if ((popup == null || popup.isOpen()==false)  && (searchPopup == null || searchPopup.isOpen() ===false)){
                popupBati = new mapboxgl.Popup({ 
                offset: [0, -15],
                closeButton: false
            })
                .setLngLat(e.lngLat)
                .setHTML('<h1>'+e.features[0].properties.id+'</h1>')
                    .addTo(map);
            }
        });
			// Reset the state-fills-hover layer's filter when the mouse leaves the layer.
		map.on("mouseleave", bati2DId, function() {
			map.setFilter(bati2DHId, ["==", "id", ""]);
            popupBati.remove();

			});	

		map.addLayer({
	        id: etiqBati2DId,
	        type: "symbol",
	        source: {
	            type: "geojson",
	            data: "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/batiments_centroides.geojson"
	        },
			layout: {
		        "text-field": "{name}",
		        "text-anchor": "center",
		        "text-size":{'base': 1.4,'stops': [[13, 2], [22, 60]]}
    		},
    		minzoom : 14,
	    	});
		};

//////////////////////////////////   Initialisation de la carte //////////////////////////////////////
	
map.on("load", function() {
	// Couche herbe
    map.addLayer({
        id: "grass",
        type: "fill",
        source: {
            type: "geojson",
            data: "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/grass.geojson"
        },
        paint: {
        	'fill-color': '#A4E463',
        	'fill-opacity':0.5
			}
    	});
	
	// Couche référentiel bati 2D
	getBati2D();	
	
	// Couche piste athletisme
	map.addLayer({
	    id: "piste_athle",
        type: "fill",
        source: {
            type: "geojson",
            data: "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/piste_athle.geojson"
        },
        paint: {
        	'fill-color': '#C09C83',
        	'fill-opacity':0.85
		}
	});
	map.addLayer({
        id: "terrainFootball",
        type: "line",
        source: {
            type: "geojson",
            data: "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/terrain_football.geojson"
        },
        "paint": {
            'line-color': '#FFFFFF',
            'line-width' : {'base': 1.2,'stops': [[13, 0.5], [22, 3]]}
            }
        });
	//Etiquettes campus
	map.addLayer({
        id: "CampusEtiquette",
        type: "symbol",
        source: {
            type: "geojson",
            data: "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/campus.geojson"
        },
		layout: {
	        "text-field": "{campus}",
	        "text-anchor": "center",
	        "text-size":11
		},
		maxzoom : 14,
    });
 

	var amphisLink = document.getElementById('Amphithéâtres');
	
	
//////////////////////////////////   Ajout des couches de base //////////////////////////////////////

	// Couche Amphithéâtres
	amphisLink.onclick = function (e) {
		if (amphisCount === 0){
			amphis = map.addLayer({
		        id: "Amphithéâtres",
		        type: "circle",
		        source: {
		            type: "geojson",
		            data: "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/points.geojson"
		        },
		        filter : [ '==','Categorie','Amphithéâtre'],
		        layout: {'visibility': 'visible'}, 
				paint: {
			        "circle-radius": {'base': 1.5,'stops': [[13, 2], [22, 60]]},
			        "circle-color" :'#003399',
			        "circle-opacity":0.9
				}
			});
			amphisEtiquette = map.addLayer({
		        id: "AmphithéâtresEtiquettes",
		        type: "symbol",
		        source: {
		            type: "geojson",
		            data: "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/points.geojson"
		        },
		        filter : [ '==','Categorie','Amphithéâtre'],
		        layout: {
		        "text-field": "{Etiquette}",
		        "text-anchor": "center",
		        "text-size":{'base': 1.5,'stops': [[13, 2], [22, 60]]}, 
				},
				paint: {
					"text-color":"white"
				},
				minzoom:15.5
			});
			Layers.push('Amphithéâtres','AmphithéâtresEtiquettes');
			amphisCount +=1;
		} else {
			var clickedLayer = this.textContent;
			e.preventDefault();
			e.stopPropagation();
			var visibility = map.getLayoutProperty(clickedLayer,'visibility');
			if (visibility === 'visible') {
				map.setLayoutProperty(clickedLayer,'visibility','none');
				map.setLayoutProperty('AmphithéâtresEtiquettes','visibility','none');
				Layers = Layers.filter(item => item != 'Amphithéâtres');
				Layers = Layers.filter(item => item != 'AmphithéâtresEtiquettes');
			} else {
				map.setLayoutProperty(clickedLayer,'visibility','visible');
				map.setLayoutProperty('AmphithéâtresEtiquettes','visibility','visible')
				Layers.push('Amphithéâtres');
				}
			};
			map.on('click', function (e) {
				var features = map.queryRenderedFeatures(e.point, { 
					layers: ['Amphithéâtres'] 
				});
				if (!features.length) {
					return;
				}
				var feature = features[0];
				popup = new mapboxgl.Popup({ 
					offset: [0, -15],
					closeButton: false
				})
					.setLngLat(feature.geometry.coordinates)
					.setHTML('<h1>'+feature.properties.Nom+'</h1><p>'+'Batiment '+feature.properties.Batiment+' '+feature.properties.Niveau+'<br>'+feature.properties.Capacite+'<br>'+feature.properties.Info+'</p>')
						.addTo(map);
				});
				map.on('mousemove', function (e) {
					var features = map.queryRenderedFeatures(e.point, { layers: Layers });
					map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
				});
			}
	
	
	
	// Couche salles informatique
	var sallesInfoLink = document.getElementById('Salles informatique');
	
	sallesInfoLink.onclick = function (e) {
		if (sallesInfoCount === 0){
			sallesInfo = map.addLayer({
		        id: "Salles informatique",
		        type: "circle",
		        source: {
		            type: "geojson",
		            data: "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/points.geojson"
		        },
		        filter : [ '==','Categorie','Salle informatique'],
		        layout: {'visibility': 'visible'}, 
				paint: {
			        "circle-radius": {'base': 1.5,'stops': [[13, 2], [22, 60]]},
			        "circle-color" :'#ff4000',
			        "circle-opacity":0.9
				}
			});
			Layers.push('Salles informatique');
			sallesInfoCount +=1;
		} else {
			var clickedLayer = this.textContent;
			e.preventDefault();
			e.stopPropagation();
			var visibility = map.getLayoutProperty(clickedLayer,'visibility');
			if (visibility === 'visible') {
				map.setLayoutProperty(clickedLayer,'visibility','none');
				Layers = Layers.filter(item => item != 'Salles informatique');
			} else {
				map.setLayoutProperty(clickedLayer,'visibility','visible');
				Layers.push('Salles informatique');
				}
			};
			
			map.on('click', function (e) {
				var features = map.queryRenderedFeatures(e.point, { 
					layers: ['Salles informatique'] 
				});
				if (!features.length) {
					return;
				}
				var feature = features[0];
				popup = new mapboxgl.Popup({ 
					offset: [0, -15],
					closeButton: false,
				})
					.setLngLat(feature.geometry.coordinates)
					.setHTML('<h1>'+feature.properties.Nom+'</h1><p>'+'Batiment '+feature.properties.Batiment+' '+feature.properties.Niveau+'<br>'+feature.properties.Capacite+'<br>'+feature.properties.Info+'</p>')
						.addTo(map);
				});
				map.on('mousemove', function (e) {
					var features = map.queryRenderedFeatures(e.point, { layers: Layers });
					map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
				});
			}
		});


// Velostar 


var geojsonVelos = null;
var previousDataVelos = { times: [], stations: [] };
var prevInfo = null;
var velostarCount = 0
var nomLayer= null
var velostarLink = document.getElementById('Stations vélostar');
velostarLink.onclick = function (e) {
    velostarCount +=1 ;
    if (velostarCount === 1){
        updateData();
        function updateData() {
            //Appel de l'API pour les vélos
            $.ajax({
                //URL de l'API
                url: "https://data.explore.star.fr/api/records/1.0/search/?dataset=vls-stations-etat-tr&facet=nom&facet=etat&facet=nombreemplacementsactuels&facet=nombreemplacementsdisponibles&facet=nombrevelosdisponibles&format=geojson&rows=150",
                
                //Type de données
                dataType: "jsonp",
                crossDomain: true,
                
                //Méthode appelée lorsque le téléchargement a fonctionné
                success: function(geojson) {
                    console.log("Données téléchargées");
                    geojsonVelos = geojson;
                    saveBikeData();
                    if (nomLayer === null) {
                        showBikeData()
                    } else {
                        var visibility = map.getLayoutProperty(nomLayer,'visibility');
                        if (visibility === 'visible'){
                            showBikeData()
                        } else {
                            console.log('données masquées')
                        }
                    };
                    setTimeout(updateData, 60*1000);
                },
                
                //Méthode appelée lorsque le téléchargement a échoué
                error: function() {
                    alert("Erreur lors du téléchargement des vélos !");
                }      
            });
        };

        function saveBikeData() {
            //On change la structure des données pour simplifier l'utilisation
            var stations = {};
            var prevStationData = null;
            geojsonVelos.features.forEach(f => {
                stations[f.properties.nom] = f.properties;
                
                //On compare avec le nombre de vélos précédent
                if(previousDataVelos.stations.length > 0) {
                    f.properties.diff = f.properties.nombrevelosdisponibles - previousDataVelos.stations[previousDataVelos.stations.length-1][f.properties.nom].nombrevelosdisponibles;
                }
                else {
                    f.properties.diff = 0;
                }
                
                //On met à jour l'affichage des infos si besoin
                if(prevInfo && prevInfo === f.properties.nom) {
                    prevStationData = f;
                }
            });
            
            previousDataVelos.times.push(Date.now());
            previousDataVelos.stations.push(stations);
            Layers = Layers.filter(item => item != "bikes"+(previousDataVelos.times.length-1));

        }
        function showBikeData() {
            //On supprime les données précédentes
            if(previousDataVelos.times.length > 1) {
                map.removeLayer("bikes"+(previousDataVelos.times.length-1));
            }
            
            //On créé un nouveau calque de données
            nomLayer = "bikes"+previousDataVelos.times.length;
            Layers.push(nomLayer);

            map.addLayer({
                id: nomLayer,
                type: "circle",
                source: {
                    type: "geojson",
                    data: geojsonVelos
                },
                filter: ["has", "diff"],
                paint: {
                    "circle-radius": {'base': 1.5,'stops': [[13, 5], [22, 60]]},
                    "circle-color": "green"
                }
            });
        }       

    } else {
        var clickedLayer = this.textContent;
        e.preventDefault();
        e.stopPropagation();
        var visibility = map.getLayoutProperty(nomLayer,'visibility');
        if (visibility === 'visible') {
            map.setLayoutProperty(nomLayer,'visibility','none');
            Layers = Layers.filter(item => item != nomLayer);
        } else {
            map.setLayoutProperty(nomLayer,'visibility','visible');
            Layers.push(nomLayer);
            }
    };
        
    map.on('click', function (e) {
        var features = map.queryRenderedFeatures(e.point, { 
            layers: [nomLayer] 
        });
        if (!features.length) {
            return;
        }
        var feature = features[0];
        popup = new mapboxgl.Popup({ 
            offset: [0, -15],
            closeButton: false,
        })
            .setLngLat(feature.geometry.coordinates)
            .setHTML('<h1> Station vélostar : '+feature.properties.nom+'</h1><p>Nombre de vélos disponibles : '+feature.properties.nombrevelosdisponibles+'<br>Nombre d\'emplacements disponibles : ' +feature.properties.nombreemplacementsdisponibles+'</p>')
                .addTo(map);
        });
        map.on('mousemove', function (e) {
            var features = map.queryRenderedFeatures(e.point, { layers: Layers });
            map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
        });    
    }


// Couche des BUS


var geojsonBus = null;
var previousDataBus = { times: [], stations: [] };
var prevInfo = null;
var busCount = 0
var nomLayerBus= null
var busLink = document.getElementById('Réseau de bus');
busLink.onclick = function (e) {
    busCount +=1;
    if (busCount === 1){
        updateBusData();
        function updateBusData() {
            //Appel de l'API pour les vélos
            $.ajax({
                //URL de l'API
                url: "https://data.explore.star.fr/api/records/1.0/search/?dataset=tco-bus-vehicules-position-tr&facet=numerobus&facet=etat&facet=nomcourtligne&facet=sens&facet=destination&facet=ecartsecondes&format=geojson&rows=500",
                
                //Type de données
                dataType: "jsonp",
                crossDomain: true,
                
                //Méthode appelée lorsque le téléchargement a fonctionné
                success: function(geojson) {
                    console.log("Données téléchargées");
                    geojsonBus = geojson;
                    saveBusData();
                    if (nomLayerBus === null) {
                        showBusData()
                    } else {
                        var visibility = map.getLayoutProperty(nomLayerBus,'visibility');
                        if (visibility === 'visible'){
                            showBusData()
                        } else {
                            console.log('données masquées')
                        }
                    };
                    setTimeout(updateBusData, 60*1000);
                },
                
                //Méthode appelée lorsque le téléchargement a échoué
                error: function() {
                    alert("Erreur lors du téléchargement des bus !");
                }      
            });
        };


        function saveBusData() {
            //On change la structure des données pour simplifier l'utilisation
            var stations = {};
            var prevStationData = null;
            
            
            previousDataBus.times.push(Date.now());
            previousDataBus.stations.push(stations);
            Layers = Layers.filter(item => item != "bus"+(previousDataBus.times.length-1));

        }
        function showBusData() {
            //On supprime les données précédentes
            if(previousDataBus.times.length > 1) {
                map.removeLayer("bus"+(previousDataBus.times.length-1));
            }
            
            //On créé un nouveau calque de données
            nomLayerBus = "bus"+previousDataBus.times.length;
            Layers.push(nomLayerBus);

            map.addLayer({
                id: nomLayerBus,
                type: "circle",
                source: {
                    type: "geojson",
                    data: geojsonBus
                },
                filter : [ '==','etat','En ligne'],                
                paint: {
                    "circle-radius": {'base': 1.7,'stops': [[13, 5], [22, 60]]},
                    "circle-color": "#0066ff"
                }
            });
        }       
        busCount +=1;

    } else {
        var clickedLayer = this.textContent;
        e.preventDefault();
        e.stopPropagation();
        var visibility = map.getLayoutProperty(nomLayerBus,'visibility');
        if (visibility === 'visible') {
            map.setLayoutProperty(nomLayerBus,'visibility','none');
            Layers = Layers.filter(item => item != nomLayerBus);
        } else {
            map.setLayoutProperty(nomLayerBus,'visibility','visible');
            Layers.push(nomLayerBus);
            }
    };
        
    map.on('click', function (e) {
        var features = map.queryRenderedFeatures(e.point, { 
            layers: [nomLayerBus] 
        });
        if (!features.length) {
            return;
        }
        var feature = features[0];
        popup = new mapboxgl.Popup({ 
            offset: [0, -15],
            closeButton: false,
        })
            .setLngLat(feature.geometry.coordinates)
            .setHTML('<h1> Bus du réseau STAR </h1><p>Ligne : '+feature.properties.nomcourtligne+'<br>A destination de : '+feature.properties.destination+'</p>')
                .addTo(map);
        });
        map.on('mousemove', function (e) {
            var features = map.queryRenderedFeatures(e.point, { layers: Layers });
            map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
        });    
    }
	
//////////////////////////////////   Interactivité menus //////////////////////////////////////


	// ZOOMS sur les campus

    document.getElementById("LaHarpe").addEventListener('click', function(){
        map.setMaxBounds(rennesBounds);
		map.flyTo({
            zoom:16,
            center:[-1.7091, 48.1254]
        });
    });
    document.getElementById("Villejean").addEventListener('click', function(){
        map.setMaxBounds(rennesBounds);
		map.flyTo({
            zoom:16,
            center:[-1.7013, 48.119365]
        });
    });
    document.getElementById("Mazier").addEventListener('click',function(){
        map.setMaxBounds(mazierBounds);
		map.flyTo({
            zoom:16,
            center:[-2.7410000,48.513033]
        });
    });
	
//////////////////////////////////  Barre de recherche //////////////////////////////////////


	var searchPOI = (function (){
			var json = null;

			$.ajax({
				'async':false,
				'global':false,
				'url' : "https://raw.githubusercontent.com/Xueimuohtreb/Plan-interactif/master/data/points.geojson",
				'dataType' : "json",
				'success' : function(data){
					json = data;
				}
					});
				return json;
		})();

	// Récupération des propriétés du json
	var POI = []; 
	POI = searchPOI.features; 
	var jproperties = searchPOI.features.map(function (el) {
		return el.properties; 
	});
	var searchValue	= null;
	var searchItem = [];
	var searchX = null;
	var searchY = null;
	var searchLayerCount = 0;
	var searchLayerId = 'SearchResult';
	var searchPopup = null

	var options = {
	    data: jproperties,
	    getValue: "Nom",
	    template: {
	        type: "description",
	        fields: {
	        // Possibilité de mettre le campus en description
	            description: "Campus"
	        }
	    },
	    list: {
	        match: {
	            enabled: true
	        }
	    },
	    theme: "plate-dark"
	};
	$("#searchfield").easyAutocomplete(options);		
    
    function getSearchPopup(){
        searchPopup= new mapboxgl.Popup({
            offset:[0,-15],
            closeButton: false
    })
        .setLngLat(searchItem.geometry.coordinates)
        .setHTML('<h1>'+searchItem.properties.Nom+'</h1>')
            .addTo(map);
    };	

	function getSearchedItem(){
		if (searchValue !==null){
	    		searchValue = null
				searchItem = [];
				searchX = null;
				searchY = null;
                Layers = Layers.filter(item => item != searchLayerId);
				searchLayerCount+=1;
				searchPopup.remove();
				map.removeLayer(searchLayerId)
				searchLayerId = 'searchResult'+searchLayerCount;
	    	};

	        searchValue = document.getElementById("searchfield").value;
	        console.log(searchValue);
			for(var i = 0; i < POI.length; i++){
	        	if (POI[i].properties.Nom === searchValue){
	        		searchItem = POI[i];
	        		map.addLayer({
	        			id: searchLayerId,
	        			type:'circle',
	        			source:{
	        				type:"geojson",
	        				data: searchItem
	        			},
	        			layout:{'visibility':'visible'},
	        			paint:{
					        "circle-radius": {'base': 1.5,'stops': [[13, 2], [22, 60]]},
					        "circle-color" :'#FF0000',
					        "circle-opacity":0.9
	        			}
	        		});
	        	Layers.push(searchLayerId);

                map.on('mousemove', function (e) {
                    var features = map.queryRenderedFeatures(e.point, { layers: Layers });
                    map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
                });
	        	searchX = searchItem.geometry.coordinates[0];
	        	searchY = searchItem.geometry.coordinates[1];
				if (POI[i].properties.Campus === 'Mazier'){
					map.setMaxBounds(mazierBounds);
				} else {
					map.setMaxBounds(rennesBounds);
				};
				if (DDD){					
					map.flyTo({
		        		center:[searchX,searchY],
		        		zoom:17.5,
		        		pitch:45,
						speed:0.6
		        	});
		        } else {
		        	map.flyTo({
		        		center:[searchX,searchY],
		        		zoom:17.5,
		        		pitch:0,
						speed:0.6
		        	});	        	
		        }

                getSearchPopup();
	        	map.on('click',function (e){
                    if (searchPopup.isOpen() == true){
                        searchPopup.remove();
                    
                    }
	        	})
            }
        }
	}
function runScriptKey(e) {
    if (e.keyCode == 13) {
    	console.log('ok');
    	getSearchedItem();
    }
}
function runScriptClic(e){
	getSearchedItem();
}
	

//////////////////////////////////   3D   //////////////////////////////////////

document.getElementById('DDD').addEventListener('click',function(){
	var X = map.getCenter()["lng"];
	var Y = map.getCenter()["lat"];
	var button = document.getElementById('DDDButton');
	if (DDD===false){
		getBati3D();
		map.flyTo({
			center:[X,Y],
			pitch:45,
			speed:0.1
		});
		button.style.backgroundColor = '#286090';
		DDD=true;
		map.dragRotate.enable();
	} else {
		getBati2D();
		map.flyTo({
			center:[X,Y],
			pitch:0,
			bearing:0,
			speed:0.1
		});	
		button.style.backgroundColor = 'grey';
		DDD=false;	
		map.dragRotate.disable();
	}
})

//////////////////////////////////   Ajout de l'habillage de la carte //////////////////////////////////////

var nav = new mapboxgl.NavigationControl();
map.addControl(nav, 'top-left');

map.addControl(new mapboxgl.ScaleControl({
maxWidth: 120,
unit: 'metric'}));

</script>
</body>
</html>
